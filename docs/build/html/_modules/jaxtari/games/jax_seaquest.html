

<!DOCTYPE html>
<html class="writer-html5" lang="python3.10" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>jaxtari.games.jax_seaquest &mdash; JAXAtari  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=478102dd" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=b0426e2b"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            JAXAtari
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../jaxtari/core.html">JAXAtari Environments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/modules.html">jaxtari</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Scripts:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../scripts/RAMStateDeltas.html">RAMStateDeltas.py</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tests and Benchmarks:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tests/benchmarks.html">Benchmark</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">JAXAtari</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">jaxtari.games.jax_seaquest</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for jaxtari.games.jax_seaquest</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">NamedTuple</span>
<span class="kn">import</span> <span class="nn">jax</span>
<span class="kn">import</span> <span class="nn">jax.numpy</span> <span class="k">as</span> <span class="nn">jnp</span>
<span class="kn">import</span> <span class="nn">chex</span>
<span class="kn">import</span> <span class="nn">pygame</span>
<span class="kn">import</span> <span class="nn">jaxtari.rendering.atraJaxis</span> <span class="k">as</span> <span class="nn">aj</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">gymnax.environments</span> <span class="kn">import</span> <span class="n">spaces</span>

<span class="kn">from</span> <span class="nn">jaxtari.environment</span> <span class="kn">import</span> <span class="n">JaxEnvironment</span>

<span class="c1"># TODO: surface submarine at 6 divers collected + difficulty 1</span>
<span class="c1"># Game Constants</span>
<span class="n">WINDOW_WIDTH</span> <span class="o">=</span> <span class="mi">160</span> <span class="o">*</span> <span class="mi">3</span>
<span class="n">WINDOW_HEIGHT</span> <span class="o">=</span> <span class="mi">210</span> <span class="o">*</span> <span class="mi">3</span>

<span class="n">WIDTH</span> <span class="o">=</span> <span class="mi">160</span>
<span class="n">HEIGHT</span> <span class="o">=</span> <span class="mi">210</span>
<span class="n">SCALING_FACTOR</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># Colors</span>
<span class="n">BACKGROUND_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">139</span><span class="p">)</span>  <span class="c1"># Dark blue for water</span>
<span class="n">PLAYER_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">187</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">53</span><span class="p">)</span>  <span class="c1"># Yellow for player sub</span>
<span class="n">DIVER_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>  <span class="c1"># Pink for divers</span>
<span class="n">SHARK_DIFFICULTY_COLORS</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">[</span><span class="mi">92</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">92</span><span class="p">],</span>  <span class="c1"># Level 0: Base green</span>
        <span class="p">[</span><span class="mi">213</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">74</span><span class="p">],</span>  <span class="c1"># Level 1: Orange (adjusted from original ROM)</span>
        <span class="p">[</span>
            <span class="mi">170</span><span class="p">,</span>
            <span class="mi">92</span><span class="p">,</span>
            <span class="mi">170</span><span class="p">,</span>
        <span class="p">],</span>  <span class="c1"># Level 2: Purple (adjusted from original ROM COLOR_KILLER_SHARK_02)</span>
        <span class="p">[</span><span class="mi">213</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">130</span><span class="p">],</span>  <span class="c1"># Level 3: Pink (adjusted from original ROM)</span>
        <span class="p">[</span><span class="mi">186</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">92</span><span class="p">],</span>  <span class="c1"># Level 4: Red (adjusted from original ROM)</span>
    <span class="p">]</span>
<span class="p">)</span>
<span class="n">ENEMY_SUB_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">170</span><span class="p">)</span>  <span class="c1"># Gray for enemy subs</span>
<span class="n">OXYGEN_BAR_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">214</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>  <span class="c1"># White for oxygen</span>
<span class="n">SCORE_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>  <span class="c1"># Score color</span>
<span class="n">OXYGEN_TEXT_COLOR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Black for oxygen text</span>

<span class="c1"># Object sizes and initial positions from RAM state</span>
<span class="n">PLAYER_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>  <span class="c1"># Width, Height</span>
<span class="n">DIVER_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">SHARK_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">ENEMY_SUB_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">MISSILE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">PLAYER_START_X</span> <span class="o">=</span> <span class="mi">76</span>
<span class="n">PLAYER_START_Y</span> <span class="o">=</span> <span class="mi">46</span>

<span class="n">X_BORDERS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">160</span><span class="p">)</span>
<span class="n">PLAYER_BOUNDS</span> <span class="o">=</span> <span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="mi">134</span><span class="p">),</span> <span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">141</span><span class="p">)</span>

<span class="c1"># Maximum number of objects (from MAX_NB_OBJECTS)</span>
<span class="n">MAX_DIVERS</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MAX_SHARKS</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">MAX_SUBS</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">MAX_ENEMY_MISSILES</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MAX_PLAYER_TORPS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MAX_SURFACE_SUBS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">MAX_COLLECTED_DIVERS</span> <span class="o">=</span> <span class="mi">6</span>

<span class="c1"># define object orientations</span>
<span class="n">FACE_LEFT</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">FACE_RIGHT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Define action space</span>
<span class="n">NOOP</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">FIRE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">UP</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">RIGHT</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">LEFT</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">DOWN</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">UPRIGHT</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">UPLEFT</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">DOWNRIGHT</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">DOWNLEFT</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">UPFIRE</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">RIGHTFIRE</span> <span class="o">=</span> <span class="mi">11</span>
<span class="n">LEFTFIRE</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">DOWNFIRE</span> <span class="o">=</span> <span class="mi">13</span>
<span class="n">UPRIGHTFIRE</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">UPLEFTFIRE</span> <span class="o">=</span> <span class="mi">15</span>
<span class="n">DOWNRIGHTFIRE</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">DOWNLEFTFIRE</span> <span class="o">=</span> <span class="mi">17</span>

<span class="n">SPAWN_POSITIONS_Y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">71</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">139</span><span class="p">])</span>  <span class="c1"># submarines at y=69?</span>
<span class="n">SUBMARINE_Y_OFFSET</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">ENEMY_MISSILE_Y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">73</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">141</span><span class="p">])</span>  <span class="c1"># missile x = submarine.x + 4</span>
<span class="n">DIVER_SPAWN_POSITIONS</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">69</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">141</span><span class="p">])</span>

<span class="n">MISSILE_SPAWN_POSITIONS</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">39</span><span class="p">,</span> <span class="mi">126</span><span class="p">])</span>  <span class="c1"># Right, Left</span>

<span class="c1"># First wave directions from original code</span>
<span class="n">FIRST_WAVE_DIRS</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>

<div class="viewcode-block" id="SpawnState">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.SpawnState">[docs]</a>
<span class="k">class</span> <span class="nc">SpawnState</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">difficulty</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Current difficulty level (0-7)</span>
    <span class="n">lane_dependent_pattern</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Track waves independently per lane [4 lanes]</span>
    <span class="n">to_be_spawned</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># tracks which enemies are still in the spawning cycle [4 lanes * 3 slots] -&gt; necessary due to the spaced out spawning of multiple enemies</span>
    <span class="n">survived</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># track if last enemy survived [4 lanes * 3 slots] -&gt; 1 if survived whilst going right, 0 if not, -1 if survived whilst going left</span>
    <span class="n">prev_sub</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Track previous entity type for each lane [4 lanes]</span>
    <span class="n">spawn_timers</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Individual spawn timers per lane [4 lanes]</span>
    <span class="n">diver_array</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># Track which divers are still in the spawning cycle [4 lanes]</span>
    <span class="n">lane_directions</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># Track lane directions for each wave [4 lanes] -&gt; 0 = right, 1 = left</span></div>



<div class="viewcode-block" id="initialize_spawn_state">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.initialize_spawn_state">[docs]</a>
<span class="k">def</span> <span class="nf">initialize_spawn_state</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">SpawnState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize spawn state with first wave matching original game.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">SpawnState</span><span class="p">(</span>
        <span class="n">difficulty</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">lane_dependent_pattern</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span>
        <span class="p">),</span>  <span class="c1"># Each lane starts at wave 0</span>
        <span class="n">to_be_spawned</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="mi">12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span>
        <span class="p">),</span>  <span class="c1"># Track which enemies are still in the spawning cycle</span>
        <span class="n">survived</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>  <span class="c1"># Track which enemies survived</span>
        <span class="n">prev_sub</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
            <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span>
        <span class="p">),</span>  <span class="c1"># Track previous entity type (0 if shark, 1 if sub) -&gt; starts at 1 since the first wave is sharks</span>
        <span class="n">spawn_timers</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="mi">277</span><span class="p">,</span> <span class="mi">277</span><span class="p">,</span> <span class="mi">277</span><span class="p">,</span> <span class="mi">277</span> <span class="o">+</span> <span class="mi">60</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span>
        <span class="p">),</span>  <span class="c1"># 277 is the std starting timer in the base game</span>
        <span class="n">diver_array</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">lane_directions</span><span class="o">=</span><span class="n">FIRST_WAVE_DIRS</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>  <span class="c1"># First wave directions</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="soft_reset_spawn_state">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.soft_reset_spawn_state">[docs]</a>
<span class="k">def</span> <span class="nf">soft_reset_spawn_state</span><span class="p">(</span><span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpawnState</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reset spawn_times&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">spawn_timers</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">277</span><span class="p">,</span> <span class="mi">277</span><span class="p">,</span> <span class="mi">277</span><span class="p">,</span> <span class="mi">277</span> <span class="o">+</span> <span class="mi">60</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="p">)</span></div>


<span class="c1"># Game state container</span>
<div class="viewcode-block" id="SeaquestState">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.SeaquestState">[docs]</a>
<span class="k">class</span> <span class="nc">SeaquestState</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">player_x</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">player_y</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">player_direction</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># 0 for right, 1 for left</span>
    <span class="n">oxygen</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">divers_collected</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">score</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">lives</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span>
    <span class="n">diver_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># (4, 3) array for divers</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># (12, 3) array for sharks - separated into 4 lanes, 3 slots per lane [left to right]</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># (12, 3) array for enemy subs - separated into 4 lanes, 3 slots per lane [left to right]</span>
    <span class="n">enemy_missile_positions</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># (4, 3) array for enemy missiles (only the front boats can shoot)</span>
    <span class="n">surface_sub_position</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># (1, 3) array for surface submarine</span>
    <span class="n">player_missile_position</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># (1, 3) array for player missile (x, y, direction)</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">just_surfaced</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Flag for tracking actual surfacing moment</span>
    <span class="n">successful_rescues</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span>  <span class="c1"># Number of times the player has surfaced with all six divers</span>
    <span class="n">death_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>  <span class="c1"># Counter for tracking death animation</span>
    <span class="n">obs_stack</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">ArrayTree</span>  <span class="c1"># Observation stack for frame stacking</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span></div>



<div class="viewcode-block" id="EntityPosition">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.EntityPosition">[docs]</a>
<span class="k">class</span> <span class="nc">EntityPosition</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">width</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">height</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">active</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span></div>



<div class="viewcode-block" id="SeaquestObservation">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.SeaquestObservation">[docs]</a>
<span class="k">class</span> <span class="nc">SeaquestObservation</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">player</span><span class="p">:</span> <span class="n">EntityPosition</span>
    <span class="n">sharks</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Shape (12, 5) - 12 sharks, each with x,y,w,h,active</span>
    <span class="n">submarines</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Shape (12, 5)</span>
    <span class="n">divers</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Shape (4, 5)</span>
    <span class="n">enemy_missiles</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Shape (4, 5)</span>
    <span class="n">surface_submarine</span><span class="p">:</span> <span class="n">EntityPosition</span>
    <span class="n">player_missile</span><span class="p">:</span> <span class="n">EntityPosition</span>
    <span class="n">collected_divers</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Number of divers collected (0-6)</span>
    <span class="n">player_score</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">lives</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">oxygen_level</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Oxygen level (0-255)</span></div>


<div class="viewcode-block" id="SeaquestInfo">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.SeaquestInfo">[docs]</a>
<span class="k">class</span> <span class="nc">SeaquestInfo</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">difficulty</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Current difficulty level</span>
    <span class="n">successful_rescues</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Number of successful rescues</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># Current step count</span>
    <span class="n">all_rewards</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span>  <span class="c1"># All rewards for the current step</span></div>



<div class="viewcode-block" id="CarryState">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.CarryState">[docs]</a>
<span class="k">class</span> <span class="nc">CarryState</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="n">missile_pos</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">shark_pos</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">sub_pos</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">score</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span></div>



<span class="c1"># RENDER CONSTANTS</span>
<div class="viewcode-block" id="load_sprites">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.load_sprites">[docs]</a>
<span class="k">def</span> <span class="nf">load_sprites</span><span class="p">():</span>
    <span class="n">MODULE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="c1"># Load sprites - no padding needed for background since it&#39;s already full size</span>
    <span class="n">bg1</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/bg/1.npy&quot;</span><span class="p">))</span>
    <span class="n">pl_sub1</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/player_sub/1.npy&quot;</span><span class="p">))</span>
    <span class="n">pl_sub2</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/player_sub/2.npy&quot;</span><span class="p">))</span>
    <span class="n">pl_sub3</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/player_sub/3.npy&quot;</span><span class="p">))</span>
    <span class="n">diver1</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/diver/1.npy&quot;</span><span class="p">))</span>
    <span class="n">diver2</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/diver/2.npy&quot;</span><span class="p">))</span>
    <span class="n">shark1</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/shark/1.npy&quot;</span><span class="p">))</span>
    <span class="n">shark2</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/shark/2.npy&quot;</span><span class="p">))</span>
    <span class="n">enemy_sub1</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/enemy_sub/1.npy&quot;</span><span class="p">))</span>
    <span class="n">enemy_sub2</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/enemy_sub/2.npy&quot;</span><span class="p">))</span>
    <span class="n">enemy_sub3</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/enemy_sub/3.npy&quot;</span><span class="p">))</span>
    <span class="n">pl_torp</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/player_torp/1.npy&quot;</span><span class="p">))</span>
    <span class="n">en_torp</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/enemy_torp/1.npy&quot;</span><span class="p">))</span>

    <span class="c1"># Pad player submarine sprites to match each other</span>
    <span class="n">pl_sub_sprites</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">pad_to_match</span><span class="p">([</span><span class="n">pl_sub1</span><span class="p">,</span> <span class="n">pl_sub2</span><span class="p">,</span> <span class="n">pl_sub3</span><span class="p">])</span>

    <span class="c1"># Pad diver sprites to match each other</span>
    <span class="n">diver_sprites</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">pad_to_match</span><span class="p">([</span><span class="n">diver1</span><span class="p">,</span> <span class="n">diver2</span><span class="p">])</span>

    <span class="c1"># Pad shark sprites to match each other</span>
    <span class="n">shark_sprites</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">pad_to_match</span><span class="p">([</span><span class="n">shark1</span><span class="p">,</span> <span class="n">shark2</span><span class="p">])</span>

    <span class="c1"># Pad enemy submarine sprites to match each other</span>
    <span class="n">enemy_sub_sprites</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">pad_to_match</span><span class="p">([</span><span class="n">enemy_sub1</span><span class="p">,</span> <span class="n">enemy_sub2</span><span class="p">,</span> <span class="n">enemy_sub3</span><span class="p">])</span>

    <span class="c1"># Pad player torpedo sprites to match each other</span>
    <span class="n">pl_torp_sprites</span> <span class="o">=</span> <span class="p">[</span><span class="n">pl_torp</span><span class="p">]</span>

    <span class="c1"># Pad enemy torpedo sprites to match each other</span>
    <span class="n">en_torp_sprites</span> <span class="o">=</span> <span class="p">[</span><span class="n">en_torp</span><span class="p">]</span>

    <span class="c1"># Background sprite (no padding needed)</span>
    <span class="n">SPRITE_BG</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">bg1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Player submarine sprites</span>
    <span class="n">SPRITE_PL_SUB</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pl_sub_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pl_sub_sprites</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pl_sub_sprites</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Diver sprites</span>
    <span class="n">SPRITE_DIVER</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">diver_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">diver_sprites</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Shark sprites</span>
    <span class="n">SPRITE_SHARK</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">shark_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">shark_sprites</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">8</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Enemy submarine sprites</span>
    <span class="n">SPRITE_ENEMY_SUB</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">enemy_sub_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">enemy_sub_sprites</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">enemy_sub_sprites</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">4</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="n">DIGITS</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">load_and_pad_digits</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;./sprites/seaquest/digits/</span><span class="si">{}</span><span class="s2">.npy&quot;</span><span class="p">))</span>
    <span class="n">LIFE_INDICATOR</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;sprites/seaquest/life_indicator/1.npy&quot;</span><span class="p">))</span>
    <span class="n">DIVER_INDICATOR</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">loadFrame</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">MODULE_DIR</span><span class="p">,</span> <span class="s2">&quot;./sprites/seaquest/diver_indicator/1.npy&quot;</span><span class="p">))</span>

    <span class="c1"># Player torpedo sprites</span>
    <span class="n">SPRITE_PL_TORP</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pl_torp_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Enemy torpedo sprites</span>
    <span class="n">SPRITE_EN_TORP</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">en_torp_sprites</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="kc">None</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">SPRITE_BG</span><span class="p">,</span>
        <span class="n">SPRITE_PL_SUB</span><span class="p">,</span>
        <span class="n">SPRITE_DIVER</span><span class="p">,</span>
        <span class="n">SPRITE_SHARK</span><span class="p">,</span>
        <span class="n">SPRITE_ENEMY_SUB</span><span class="p">,</span>
        <span class="n">SPRITE_PL_TORP</span><span class="p">,</span>
        <span class="n">SPRITE_EN_TORP</span><span class="p">,</span>
        <span class="n">DIGITS</span><span class="p">,</span>
        <span class="n">LIFE_INDICATOR</span><span class="p">,</span>
        <span class="n">DIVER_INDICATOR</span><span class="p">,</span>
    <span class="p">)</span></div>



<span class="c1"># Load sprites once at module level</span>
<span class="p">(</span>
    <span class="n">SPRITE_BG</span><span class="p">,</span>
    <span class="n">SPRITE_PL_SUB</span><span class="p">,</span>
    <span class="n">SPRITE_DIVER</span><span class="p">,</span>
    <span class="n">SPRITE_SHARK</span><span class="p">,</span>
    <span class="n">SPRITE_ENEMY_SUB</span><span class="p">,</span>
    <span class="n">SPRITE_PL_TORP</span><span class="p">,</span>
    <span class="n">SPRITE_EN_TORP</span><span class="p">,</span>
    <span class="n">DIGITS</span><span class="p">,</span>
    <span class="n">LIFE_INDICATOR</span><span class="p">,</span>
    <span class="n">DIVER_INDICATOR</span><span class="p">,</span>
<span class="p">)</span> <span class="o">=</span> <span class="n">load_sprites</span><span class="p">()</span>

<div class="viewcode-block" id="check_collision_single">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.check_collision_single">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">check_collision_single</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">pos2</span><span class="p">,</span> <span class="n">size2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check collision between two single entities&quot;&quot;&quot;</span>
    <span class="c1"># Calculate edges for rectangle 1</span>
    <span class="n">rect1_left</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect1_right</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect1_top</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rect1_bottom</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Calculate edges for rectangle 2</span>
    <span class="n">rect2_left</span> <span class="o">=</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect2_right</span> <span class="o">=</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect2_top</span> <span class="o">=</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rect2_bottom</span> <span class="o">=</span> <span class="n">pos2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check overlap</span>
    <span class="n">horizontal_overlap</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">rect1_left</span> <span class="o">&lt;</span> <span class="n">rect2_right</span><span class="p">,</span>
        <span class="n">rect1_right</span> <span class="o">&gt;</span> <span class="n">rect2_left</span>
    <span class="p">)</span>

    <span class="n">vertical_overlap</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">rect1_top</span> <span class="o">&lt;</span> <span class="n">rect2_bottom</span><span class="p">,</span>
        <span class="n">rect1_bottom</span> <span class="o">&gt;</span> <span class="n">rect2_top</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">horizontal_overlap</span><span class="p">,</span> <span class="n">vertical_overlap</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_collision_batch">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.check_collision_batch">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">check_collision_batch</span><span class="p">(</span><span class="n">pos1</span><span class="p">,</span> <span class="n">size1</span><span class="p">,</span> <span class="n">pos2_array</span><span class="p">,</span> <span class="n">size2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check collision between one entity and an array of entities&quot;&quot;&quot;</span>
    <span class="c1"># Calculate edges for rectangle 1</span>
    <span class="n">rect1_left</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect1_right</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect1_top</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">rect1_bottom</span> <span class="o">=</span> <span class="n">pos1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Calculate edges for all rectangles in pos2_array</span>
    <span class="n">rect2_left</span> <span class="o">=</span> <span class="n">pos2_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">rect2_right</span> <span class="o">=</span> <span class="n">pos2_array</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">size2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rect2_top</span> <span class="o">=</span> <span class="n">pos2_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">rect2_bottom</span> <span class="o">=</span> <span class="n">pos2_array</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">size2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Check overlap for all entities</span>
    <span class="n">horizontal_overlaps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">rect1_left</span> <span class="o">&lt;</span> <span class="n">rect2_right</span><span class="p">,</span>
        <span class="n">rect1_right</span> <span class="o">&gt;</span> <span class="n">rect2_left</span>
    <span class="p">)</span>

    <span class="n">vertical_overlaps</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">rect1_top</span> <span class="o">&lt;</span> <span class="n">rect2_bottom</span><span class="p">,</span>
        <span class="n">rect1_bottom</span> <span class="o">&gt;</span> <span class="n">rect2_top</span>
    <span class="p">)</span>

    <span class="c1"># Combine checks for each entity</span>
    <span class="n">collisions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">horizontal_overlaps</span><span class="p">,</span> <span class="n">vertical_overlaps</span><span class="p">)</span>

    <span class="c1"># Return true if any collision detected</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">collisions</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_missile_collisions">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.check_missile_collisions">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">check_missile_collisions</span><span class="p">(</span>
    <span class="n">missile_pos</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">score</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">successful_rescues</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">SpawnState</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check for collisions between player missile and enemies&quot;&quot;&quot;</span>
    <span class="c1"># Create missile position array for collision check</span>
    <span class="n">missile_rect_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">missile_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">missile_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">missile_active</span> <span class="o">=</span> <span class="n">missile_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="c1"># Split RNG for collision detection and direction randomization</span>
    <span class="n">rng_key</span><span class="p">,</span> <span class="n">direction_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng_key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_enemy_collisions</span><span class="p">(</span><span class="n">enemy_idx</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="c1"># Unpack carry state</span>
        <span class="n">missile_pos</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">spawn_state</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Check shark collisions - only if missile is active</span>
        <span class="n">shark_collision</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">missile_active</span><span class="p">,</span>
            <span class="n">check_collision_single</span><span class="p">(</span>  <span class="c1"># Use single version</span>
                <span class="n">missile_rect_pos</span><span class="p">,</span> <span class="n">MISSILE_SIZE</span><span class="p">,</span>
                <span class="n">shark_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">],</span> <span class="n">SHARK_SIZE</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check submarine collisions - only if missile is active</span>
        <span class="n">sub_collision</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">missile_active</span><span class="p">,</span>
            <span class="n">check_collision_single</span><span class="p">(</span>  <span class="c1"># Use single version</span>
                <span class="n">missile_rect_pos</span><span class="p">,</span> <span class="n">MISSILE_SIZE</span><span class="p">,</span>
                <span class="n">sub_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">],</span> <span class="n">ENEMY_SUB_SIZE</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Update positions and score - use where instead of if statements</span>
        <span class="n">new_shark_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">shark_collision</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">]),</span>
            <span class="n">shark_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">new_sub_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">sub_collision</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">]),</span>
            <span class="n">sub_positions</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Update score</span>
        <span class="n">score_increase</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">shark_collision</span><span class="p">,</span>
            <span class="n">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sub_collision</span><span class="p">,</span> <span class="n">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Remove missile if it hit anything</span>
        <span class="n">new_missile_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">shark_collision</span><span class="p">,</span> <span class="n">sub_collision</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">missile_pos</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update the kill tracking in spawn state</span>
        <span class="n">any_collision</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">shark_collision</span><span class="p">,</span> <span class="n">sub_collision</span><span class="p">)</span>
        <span class="n">new_survived</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">any_collision</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Set to False when destroyed by missile</span>
                <span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Update spawn timers when enemy destroyed</span>
        <span class="n">lane_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">enemy_idx</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">new_spawn_timers</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">any_collision</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">new_lane_directions</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span>
        <span class="c1"># if survived is true, also randomize the lane direction for the next spawn cycle -&gt; this might lead to some unnecessary randomization, but the impact on performance should be negligible</span>
        <span class="n">new_lane_directions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">any_collision</span><span class="p">,</span>
            <span class="n">new_lane_directions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">enemy_idx</span> <span class="o">//</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">direction_rng</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">new_lane_directions</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Create updated spawn state (including lane_directions field)</span>
        <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">SpawnState</span><span class="p">(</span>
            <span class="n">difficulty</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="n">lane_dependent_pattern</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_dependent_pattern</span><span class="p">,</span>
            <span class="n">to_be_spawned</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">,</span>
            <span class="n">spawn_timers</span><span class="o">=</span><span class="n">new_spawn_timers</span><span class="p">,</span>
            <span class="n">prev_sub</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">,</span>
            <span class="n">survived</span><span class="o">=</span><span class="n">new_survived</span><span class="p">,</span>
            <span class="n">diver_array</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">diver_array</span><span class="p">,</span>
            <span class="n">lane_directions</span><span class="o">=</span><span class="n">new_lane_directions</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">new_missile_pos</span><span class="p">,</span>
            <span class="n">shark_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">new_shark_pos</span><span class="p">),</span>
            <span class="n">sub_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">enemy_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">new_sub_pos</span><span class="p">),</span>
            <span class="n">score</span> <span class="o">+</span> <span class="n">score_increase</span><span class="p">,</span>
            <span class="n">new_spawn_state</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Run collision detection for each possible enemy</span>
    <span class="n">missile_pos</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">spawn_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">shark_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">check_enemy_collisions</span><span class="p">,</span>
        <span class="p">(</span><span class="n">missile_pos</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">spawn_state</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">missile_pos</span><span class="p">,</span>
        <span class="n">shark_positions</span><span class="p">,</span>
        <span class="n">sub_positions</span><span class="p">,</span>
        <span class="n">score</span><span class="p">,</span>
        <span class="n">spawn_state</span><span class="p">,</span>
        <span class="n">direction_rng</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="check_player_collision">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.check_player_collision">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">check_player_collision</span><span class="p">(</span>
    <span class="n">player_x</span><span class="p">,</span>
    <span class="n">player_y</span><span class="p">,</span>
    <span class="n">submarine_list</span><span class="p">,</span>
    <span class="n">shark_list</span><span class="p">,</span>
    <span class="n">surface_sub_pos</span><span class="p">,</span>
    <span class="n">enemy_projectile_list</span><span class="p">,</span>
    <span class="n">score</span><span class="p">,</span>
    <span class="n">successful_rescues</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
    <span class="c1"># check if the player has collided with any of the three given lists</span>
    <span class="c1"># the player is a 16x11 rectangle</span>
    <span class="c1"># the submarine is a 8x11 rectangle</span>
    <span class="c1"># the shark is a 8x7 rectangle</span>
    <span class="c1"># the missile is a 8x1 rectangle</span>
    <span class="c1"># the surface submarine is 8x11 as well</span>

    <span class="c1"># check if the player has collided with any of the submarines</span>
    <span class="n">submarine_collisions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">check_collision_batch</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">]),</span> <span class="n">PLAYER_SIZE</span><span class="p">,</span> <span class="n">submarine_list</span><span class="p">,</span> <span class="n">ENEMY_SUB_SIZE</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># check if the player has collided with any of the sharks</span>
    <span class="n">shark_collisions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">check_collision_batch</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">]),</span> <span class="n">PLAYER_SIZE</span><span class="p">,</span> <span class="n">shark_list</span><span class="p">,</span> <span class="n">SHARK_SIZE</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># check if the player collided with the surface submarine</span>
    <span class="n">surface_collision</span> <span class="o">=</span> <span class="n">check_collision_single</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">]),</span>
        <span class="n">PLAYER_SIZE</span><span class="p">,</span>
        <span class="n">surface_sub_pos</span><span class="p">,</span>
        <span class="n">ENEMY_SUB_SIZE</span>
    <span class="p">)</span>

    <span class="c1"># check if the player has collided with any of the enemy projectiles</span>
    <span class="n">missile_collisions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">check_collision_batch</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">]),</span>
            <span class="n">PLAYER_SIZE</span><span class="p">,</span>
            <span class="n">enemy_projectile_list</span><span class="p">,</span>
            <span class="n">MISSILE_SIZE</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Calculate points for collisions.</span>
    <span class="c1"># When colliding with a shark or submarine the player gains points similar to killing the object</span>
    <span class="n">collision_points</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">shark_collisions</span><span class="p">,</span>
        <span class="n">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">submarine_collisions</span><span class="p">,</span>
            <span class="n">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">surface_collision</span><span class="p">,</span> <span class="n">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">submarine_collisions</span><span class="p">,</span>
                    <span class="n">shark_collisions</span><span class="p">,</span>
                    <span class="n">missile_collisions</span><span class="p">,</span>
                    <span class="n">surface_collision</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">collision_points</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="get_spawn_position">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.get_spawn_position">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">get_spawn_position</span><span class="p">(</span><span class="n">moving_left</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">slot</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get spawn position based on movement direction and slot number&quot;&quot;&quot;</span>
    <span class="n">base_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SPAWN_POSITIONS_Y</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span>
    <span class="n">x_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">moving_left</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>  <span class="c1"># Start right if moving left</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># Start left if moving right</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># -1 for left, 1 for right</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">base_y</span><span class="p">,</span> <span class="n">direction</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_slot_empty">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.is_slot_empty">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">is_slot_empty</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if a position slot is empty (0,0,ß)&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="get_front_entity">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.get_front_entity">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">get_front_entity</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lane_positions</span><span class="p">):</span>
    <span class="c1"># check on the first submarine in the lane which direction they are going</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">direction</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lane_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">),</span>
        <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># if direction is 1, go from right to left until an active entity is found</span>
    <span class="c1"># if direction is -1, go from left to right until an active entity is found</span>
    <span class="n">front_entity</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lane_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lane_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">lane_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">lane_positions</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">lane_positions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lane_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">front_entity</span></div>


<div class="viewcode-block" id="get_pattern_for_difficulty">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.get_pattern_for_difficulty">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">get_pattern_for_difficulty</span><span class="p">(</span>
    <span class="n">current_pattern</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">moving_left</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns spawn pattern based on the lane&#39;s current wave/pattern number</span>

<span class="sd">    Pattern meanings:</span>
<span class="sd">    0: Single enemy (initial pattern)</span>
<span class="sd">    1: Two adjacent enemies</span>
<span class="sd">    2: Two enemies with gap</span>
<span class="sd">    3: Three enemies in a row</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Basic pattern arrays for different formations</span>
    <span class="n">PATTERNS</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># wave 0: Single enemy</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># wave 1: Two adjacent</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># wave 2: Two with gap</span>
            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># wave 3: Three in row</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Reverse pattern if moving left</span>
    <span class="n">base_pattern</span> <span class="o">=</span> <span class="n">PATTERNS</span><span class="p">[</span><span class="n">current_pattern</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">base_pattern</span></div>


<div class="viewcode-block" id="update_enemy_spawns">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.update_enemy_spawns">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">update_enemy_spawns</span><span class="p">(</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SpawnState</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update enemy spawns using pattern-based system matching original game.</span>
<span class="sd">    Args:</span>
<span class="sd">        spawn_state: Current spawn state</span>
<span class="sd">        shark_positions: Current shark positions</span>
<span class="sd">        sub_positions: Current submarine positions</span>
<span class="sd">        step_counter: Current step counter</span>
<span class="sd">        rng: Optional random key for direction randomization</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of updated spawn state, shark positions, sub positions, and updated RNG key</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># count down the spawn timers</span>
    <span class="n">new_spawn_timers</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">new_state</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">spawn_timers</span><span class="o">=</span><span class="n">new_spawn_timers</span><span class="p">)</span>

    <span class="c1"># Define a function for jax.lax.scan to process each lane</span>
    <span class="k">def</span> <span class="nf">scan_lanes</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">lane_idx</span><span class="p">):</span>
        <span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_shark_positions</span><span class="p">,</span> <span class="n">curr_sub_positions</span><span class="p">,</span> <span class="n">curr_rng</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Check if this lane needs an update</span>
        <span class="n">needs_update</span> <span class="o">=</span> <span class="n">lane_needs_update</span><span class="p">(</span><span class="n">lane_idx</span><span class="p">,</span> <span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_shark_positions</span><span class="p">,</span> <span class="n">curr_sub_positions</span><span class="p">)</span>

        <span class="c1"># Process the lane if needed</span>
        <span class="n">new_carry</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">needs_update</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">process_lane</span><span class="p">(</span><span class="n">lane_idx</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
            <span class="p">(</span><span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_shark_positions</span><span class="p">,</span> <span class="n">curr_sub_positions</span><span class="p">,</span> <span class="n">curr_rng</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_carry</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># None for outputs as we only care about final state</span>

    <span class="k">def</span> <span class="nf">initialize_new_spawn_cycle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="n">spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Split RNG key for this lane</span>
        <span class="n">rng</span><span class="p">,</span> <span class="n">lane_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

        <span class="c1"># Get survived status for this lane (3 slots)</span>
        <span class="n">lane_survived</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>

        <span class="c1"># Update the difficulty patterns for this lane</span>
        <span class="n">left_over</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lane_survived</span><span class="p">)</span>
        <span class="n">clipped_difficulty</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="c1"># Update spawn state</span>
        <span class="n">lane_specific_pattern</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">left_over</span><span class="p">),</span>  <span class="c1"># Only update if all destroyed</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">clipped_difficulty</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">,</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">clipped_difficulty</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">clipped_difficulty</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="mi">2</span><span class="p">,</span>
                        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">clipped_difficulty</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
            <span class="p">),</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_dependent_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">moving_left</span> <span class="o">=</span> <span class="p">(</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>

        <span class="c1"># get the spawn pattern for this lane</span>
        <span class="c1"># Check if this slot had something survive last time (if yes, we have to overwrite the current_pattern)</span>
        <span class="n">current_pattern</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">left_over</span><span class="p">,</span>
            <span class="n">lane_survived</span><span class="p">,</span>
            <span class="n">get_pattern_for_difficulty</span><span class="p">(</span><span class="n">lane_specific_pattern</span><span class="p">,</span> <span class="n">moving_left</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># make sure that in the current pattern all entries are positive (i.e. abs() on all values)</span>
        <span class="n">current_pattern</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">current_pattern</span><span class="p">)</span>

        <span class="c1"># in case we are going left, flip the pattern</span>
        <span class="n">current_pattern</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">moving_left</span><span class="p">,</span> <span class="o">-</span><span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">current_pattern</span><span class="p">),</span> <span class="n">current_pattern</span>
        <span class="p">)</span>

        <span class="c1"># check if this should be a submarine or a shark</span>
        <span class="n">is_sub</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">left_over</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># set the positions for the first enemy in the wave (dependent on the direction this is either the first or the last slot)</span>
        <span class="n">first_slot</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">base_pos</span> <span class="o">=</span> <span class="n">get_spawn_position</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="c1"># spawn the first enemy in the wave</span>
        <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">is_sub</span><span class="p">,</span>
            <span class="n">shark_positions</span><span class="p">,</span>
            <span class="n">shark_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">first_slot</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">base_pos</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">new_sub_positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">is_sub</span><span class="p">,</span> <span class="n">sub_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">first_slot</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">base_pos</span><span class="p">),</span> <span class="n">sub_positions</span>
        <span class="p">)</span>

        <span class="c1"># wipe the survived status for this lane (since we are starting a new wave)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">new_survived_full</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Set moving_left to the opposite of moving_left when determining which slot to clear in to_be_spawned</span>
        <span class="n">new_to_be_spawned</span> <span class="o">=</span> <span class="n">current_pattern</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Update the full to_be_spawned array for this lane</span>
        <span class="n">new_full_to_be_spawned</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">new_to_be_spawned</span>
        <span class="p">)</span>

        <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">SpawnState</span><span class="p">(</span>
            <span class="n">difficulty</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="n">lane_dependent_pattern</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_dependent_pattern</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">lane_specific_pattern</span>
            <span class="p">),</span>
            <span class="n">to_be_spawned</span><span class="o">=</span><span class="n">new_full_to_be_spawned</span><span class="p">,</span>
            <span class="n">survived</span><span class="o">=</span><span class="n">new_survived_full</span><span class="p">,</span>
            <span class="n">prev_sub</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">is_sub</span><span class="p">),</span>
            <span class="n">spawn_timers</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
            <span class="n">diver_array</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">diver_array</span><span class="p">,</span>
            <span class="n">lane_directions</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">rng</span>

    <span class="c1"># Modified continue_spawn_cycle to handle RNG</span>
    <span class="k">def</span> <span class="nf">continue_spawn_cycle</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="n">spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Rest of function remains the same, just pass along the RNG</span>
        <span class="c1"># get the relevant missing entities for this lane from the to_be_spawned array</span>
        <span class="n">relevant_to_be_spawned</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="c1"># check in which direction we are moving by finding the first non-zero value in the missing_entities array</span>
        <span class="n">moving_left</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Find the index of the first non-zero value based on direction</span>
        <span class="k">def</span> <span class="nf">scan_right_to_left</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="mi">2</span> <span class="o">-</span> <span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">scan_left_to_right</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="c1"># Use fori_loop to scan array in appropriate direction</span>
        <span class="n">spawn_idx</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">moving_left</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">scan_left_to_right</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">scan_right_to_left</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">spawn_idx</span> <span class="o">=</span> <span class="n">spawn_idx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="c1"># Get reference x position from neighboring entity</span>
        <span class="c1"># For moving right, look at entity to the right (spawn_idx + 1)</span>
        <span class="c1"># For moving left, look at entity to the left (spawn_idx - 1)</span>
        <span class="n">reference_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="n">spawn_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spawn_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">reference_idx</span> <span class="o">=</span> <span class="n">reference_idx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># Base index for this lane&#39;s entities</span>

        <span class="c1"># Get position from either shark or sub position arrays</span>
        <span class="c1"># We&#39;ll need to check both since we don&#39;t know which type exists</span>
        <span class="n">reference_shark_pos</span> <span class="o">=</span> <span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">reference_idx</span><span class="p">]</span>
        <span class="n">reference_sub_pos</span> <span class="o">=</span> <span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">reference_idx</span><span class="p">]</span>

        <span class="c1"># Use whichever position is non-zero (active)</span>
        <span class="n">reference_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">reference_shark_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reference_shark_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reference_sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">edge_case</span> <span class="o">=</span> <span class="n">reference_x</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="c1"># Edge Case: third option exists for the pattern 1 0 1, then check the next entity</span>
        <span class="n">edge_case_reference_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="n">spawn_idx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">spawn_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">edge_case_reference_idx</span> <span class="o">=</span> <span class="n">edge_case_reference_idx</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">reference_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">edge_case</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">edge_case_reference_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">edge_case_reference_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">edge_case_reference_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="n">reference_x</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get base spawn position for this lane</span>
        <span class="n">base_spawn_pos</span> <span class="o">=</span> <span class="n">get_spawn_position</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="c1"># check if the base spawn position x is 16 / 32 pixels away from the reference x position (depending on the edge case pattern)</span>
        <span class="c1"># if yes, spawn the entity, if no, do nothing</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">edge_case</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">base_spawn_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_x</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">offset</span>

        <span class="c1"># in case reference_x is still 0 (happens in case the player destroyed the first entity in the wave), we just instantly spawn the entity</span>
        <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">reference_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">should_spawn</span><span class="p">)</span>

        <span class="n">spawn_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_spawn</span><span class="p">,</span> <span class="n">base_spawn_pos</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Update positions based on enemy type</span>
        <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">shark_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                <span class="n">spawn_pos</span><span class="p">,</span>
                <span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">new_sub_positions</span> <span class="o">=</span> <span class="n">sub_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">spawn_pos</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Update the to_be_spawned array</span>
        <span class="n">new_to_be_spawned</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">should_spawn</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># Single value</span>
                <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">spawn_idx</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Then create the new spawn state with the updated array</span>
        <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">SpawnState</span><span class="p">(</span>
            <span class="n">difficulty</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="n">lane_dependent_pattern</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_dependent_pattern</span><span class="p">,</span>
            <span class="n">to_be_spawned</span><span class="o">=</span><span class="n">new_to_be_spawned</span><span class="p">,</span>
            <span class="n">survived</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="p">,</span>
            <span class="n">prev_sub</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">,</span>
            <span class="n">spawn_timers</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="p">,</span>
            <span class="n">diver_array</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">diver_array</span><span class="p">,</span>
            <span class="n">lane_directions</span><span class="o">=</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">rng</span>

    <span class="c1"># Modified process_lane to handle RNG</span>
    <span class="k">def</span> <span class="nf">process_lane</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="n">loc_spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">rng</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># Base index for this lane&#39;s slots</span>

        <span class="c1"># determine if we need to initialize a new pattern or keep spawning for the current one</span>
        <span class="c1"># do this by checking in the relevant part of the to_be_spawned array if there are still 1s</span>
        <span class="n">relevant_to_be_spawned</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="c1"># if there are still 1s in the relevant part of the to_be_spawned array, keep spawning</span>
        <span class="n">keep_spawning</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">)</span>

        <span class="c1"># check the lane spawn timer</span>
        <span class="n">lane_timer</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="n">lane_empty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># if the lane timer is unequal to 0, continue_spawn_cycle may still be called but initialize_new_spawn_cycle should not be called</span>
        <span class="n">allow_new_initialization</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lane_timer</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lane_empty</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">handle_no_spawning</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">allow_new_initialization</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">initialize_new_spawn_cycle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
                <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span>  <span class="c1"># Return unchanged state</span>
                <span class="n">x</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">keep_spawning</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">continue_spawn_cycle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span>
            <span class="n">handle_no_spawning</span><span class="p">,</span>
            <span class="p">(</span><span class="n">loc_spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">rng</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_rng</span>

    <span class="c1"># Modify lane_needs_update to work with the rest of the function</span>
    <span class="k">def</span> <span class="nf">lane_needs_update</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">):</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>  <span class="c1"># Base index for this lane&#39;s slots</span>

        <span class="c1"># get how many entities in this lane are inactive</span>
        <span class="n">lane_empty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># check if the to_be_spawned array has any 1s in the relevant part</span>
        <span class="n">relevant_to_be_spawned</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">lane_empty</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">relevant_to_be_spawned</span><span class="p">))</span>

    <span class="c1"># Replace the manual loop with lax.scan</span>
    <span class="n">lane_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">(</span><span class="n">final_state</span><span class="p">,</span> <span class="n">final_shark_positions</span><span class="p">,</span> <span class="n">final_sub_positions</span><span class="p">,</span> <span class="n">final_rng</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">scan_lanes</span><span class="p">,</span>
        <span class="p">(</span><span class="n">new_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">rng</span> <span class="k">if</span> <span class="n">rng</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">)),</span>
        <span class="n">lane_indices</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">final_state</span><span class="p">,</span> <span class="n">final_shark_positions</span><span class="p">,</span> <span class="n">final_sub_positions</span><span class="p">,</span> <span class="n">final_rng</span></div>


<div class="viewcode-block" id="step_enemy_movement">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.step_enemy_movement">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">step_enemy_movement</span><span class="p">(</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">SpawnState</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update enemy positions based on their patterns&quot;&quot;&quot;</span>
    <span class="c1"># Split RNG key for direction randomization</span>
    <span class="n">rng</span><span class="p">,</span> <span class="n">direction_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_shark_offset</span><span class="p">(</span>
        <span class="n">step_counter</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># shark offset should be constant over the difficulty levels..</span>
        <span class="n">phase</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">//</span> <span class="mi">4</span>
        <span class="n">cycle_position</span> <span class="o">=</span> <span class="n">phase</span> <span class="o">%</span> <span class="mi">32</span>

        <span class="n">raw_offset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">cycle_position</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">,</span>
            <span class="n">cycle_position</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 0-&gt;7</span>
            <span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">cycle_position</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># 7-&gt;0</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">raw_offset</span> <span class="o">-</span> <span class="mi">4</span>

    <span class="k">def</span> <span class="nf">calculate_movement_speed</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate movement speed with JIT-compatible operations.</span>
<span class="sd">        Uses array indexing and jnp.select for cleaner, switch-case-like behavior.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_counter: Current step counter</span>
<span class="sd">            difficulty: Current difficulty level (0-255)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Movement speed for the current frame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cycle_pos</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">12</span>

        <span class="c1"># Handling difficulties 0-9 using array lookup</span>

        <span class="c1"># Ensure difficulty is non-negative (safety check)</span>
        <span class="n">safe_difficulty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">)</span>

        <span class="c1"># Create a boolean array for each difficulty bracket (0-9)</span>
        <span class="n">diff_brackets</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">safe_difficulty</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Difficulty 0</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">safe_difficulty</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">safe_difficulty</span> <span class="o">&lt;=</span> <span class="mi">2</span>
                <span class="p">),</span>  <span class="c1"># Difficulty 1-2</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">safe_difficulty</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">safe_difficulty</span> <span class="o">&lt;=</span> <span class="mi">4</span>
                <span class="p">),</span>  <span class="c1"># Difficulty 3-4</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">safe_difficulty</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">safe_difficulty</span> <span class="o">&lt;=</span> <span class="mi">6</span>
                <span class="p">),</span>  <span class="c1"># Difficulty 5-6</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">safe_difficulty</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">safe_difficulty</span> <span class="o">&lt;=</span> <span class="mi">8</span>
                <span class="p">),</span>  <span class="c1"># Difficulty 7-8</span>
                <span class="n">safe_difficulty</span> <span class="o">==</span> <span class="mi">9</span><span class="p">,</span>  <span class="c1"># Difficulty 9</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create an array of movement patterns</span>
        <span class="n">should_move_patterns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">cycle_pos</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Difficulty 0: 33% movement (1 in 3 frames)</span>
                <span class="p">(</span><span class="n">cycle_pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Difficulty 1-2: 50% movement (1 in 2 frames)</span>
                <span class="p">(</span><span class="n">cycle_pos</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># Difficulty 3-4: 67% movement (2 in 3 frames)</span>
                <span class="p">(</span><span class="n">cycle_pos</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># Difficulty 5-6: 75% movement (3 in 4 frames)</span>
                <span class="p">(</span><span class="n">cycle_pos</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Difficulty 7-8: 83% movement (5 in 6 frames)</span>
                <span class="n">cycle_pos</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">,</span>  <span class="c1"># Difficulty 9: 92% movement (11 in 12 frames)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Use jnp.select to choose the correct movement pattern (like a switch-case)</span>
        <span class="c1"># Default to False to ensure predictable behavior for unexpected difficulty values</span>
        <span class="n">should_move</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">diff_brackets</span><span class="p">,</span> <span class="n">should_move_patterns</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># For difficulties 0-9, return 1 if should move, 0 otherwise</span>
        <span class="n">speed_for_diff_0_9</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_move</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># For difficulty 10+</span>
        <span class="c1"># Handle wrapping at difficulty 255</span>
        <span class="n">adjusted_difficulty</span> <span class="o">=</span> <span class="n">difficulty</span> <span class="o">%</span> <span class="mi">256</span>

        <span class="c1"># Handle difficulty 10+ with tier-based speeds</span>
        <span class="c1"># For difficulties &lt; 10, these calculations aren&#39;t used</span>
        <span class="n">diff_above_threshold</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">adjusted_difficulty</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># Base speed calculation (tier-based)</span>
        <span class="c1"># Difficulty 10-25: Base speed 1</span>
        <span class="c1"># Difficulty 26-41: Base speed 2, etc.</span>
        <span class="n">base_speed</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">diff_above_threshold</span> <span class="o">//</span> <span class="mi">16</span><span class="p">)</span>

        <span class="c1"># Calculate position within the current tier (0-15)</span>
        <span class="n">position_in_tier</span> <span class="o">=</span> <span class="n">diff_above_threshold</span> <span class="o">%</span> <span class="mi">16</span>

        <span class="c1"># Create position bracket array (much cleaner than nested where statements)</span>
        <span class="n">pos_brackets</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">position_in_tier</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 0</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">3</span>
                <span class="p">),</span>  <span class="c1"># Position 1-3</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">6</span>
                <span class="p">),</span>  <span class="c1"># Position 4-6</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">9</span>
                <span class="p">),</span>  <span class="c1"># Position 7-9</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">12</span>
                <span class="p">),</span>  <span class="c1"># Position 10-12</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">14</span>
                <span class="p">),</span>  <span class="c1"># Position 13-14</span>
                <span class="n">position_in_tier</span> <span class="o">==</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># Position 15</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create array of higher speed patterns</span>
        <span class="n">higher_speed_patterns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 0: 1 in 16 frames (6.25%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 1-3: 1 in 8 frames (12.5%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 4-6: 1 in 4 frames (25%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 7-9: 1 in 2 frames (50%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 10-12: 3 in 4 frames (75%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 13-14: 7 in 8 frames (87.5%)</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Position 15: 15 in 16 frames (93.75%)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Use jnp.select to choose the pattern (like a switch-case)</span>
        <span class="n">use_higher_speed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pos_brackets</span><span class="p">,</span> <span class="n">higher_speed_patterns</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Higher speed is base_speed + 1</span>
        <span class="n">higher_speed</span> <span class="o">=</span> <span class="n">base_speed</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Speed for difficulty 10+: either base_speed or higher_speed</span>
        <span class="n">speed_for_diff_10_plus</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_higher_speed</span><span class="p">,</span> <span class="n">higher_speed</span><span class="p">,</span> <span class="n">base_speed</span><span class="p">)</span>

        <span class="c1"># Return appropriate speed based on difficulty</span>
        <span class="c1"># Use safe_difficulty to ensure consistent behavior with negative inputs</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">safe_difficulty</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">speed_for_diff_0_9</span><span class="p">,</span> <span class="n">speed_for_diff_10_plus</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">move_enemy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">is_shark</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">step_counter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move enemy based on difficulty and pattern.</span>

<span class="sd">        Args:</span>
<span class="sd">            pos: Current position (x, y, direction)</span>
<span class="sd">            is_shark: Boolean indicating if this is a shark</span>
<span class="sd">            difficulty: Current difficulty level (0-255)</span>
<span class="sd">            slot_idx: Slot index (for lane determination)</span>
<span class="sd">            step_counter: Current step counter</span>

<span class="sd">        Returns:</span>
<span class="sd">            New position and whether the enemy is out of bounds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_active</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">is_slot_empty</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
        <span class="n">moving_left</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>

        <span class="c1"># Calculate movement speed for this frame</span>
        <span class="n">movement_speed</span> <span class="o">=</span> <span class="n">calculate_movement_speed</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">)</span>

        <span class="c1"># Apply direction</span>
        <span class="n">velocity_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="o">-</span><span class="n">movement_speed</span><span class="p">,</span> <span class="n">movement_speed</span><span class="p">)</span>

        <span class="c1"># Base Y position comes from spawn positions</span>
        <span class="n">base_y</span> <span class="o">=</span> <span class="n">SPAWN_POSITIONS_Y</span><span class="p">[</span><span class="n">slot_idx</span> <span class="o">//</span> <span class="mi">3</span><span class="p">]</span>  <span class="c1"># Divide by 3 to get lane index</span>

        <span class="c1"># Calculate Y position</span>
        <span class="n">y_position</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">is_shark</span><span class="p">,</span>
            <span class="n">base_y</span> <span class="o">+</span> <span class="n">get_shark_offset</span><span class="p">(</span><span class="n">step_counter</span><span class="p">),</span>
            <span class="c1"># Submarines are 2 pixels higher than their base position</span>
            <span class="n">base_y</span> <span class="o">-</span> <span class="n">SUBMARINE_Y_OFFSET</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Apply movements</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">is_active</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">velocity_x</span><span class="p">,</span> <span class="n">y_position</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]]),</span> <span class="n">pos</span>
        <span class="p">)</span>

        <span class="c1"># Check bounds</span>
        <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">168</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">new_pos</span><span class="p">),</span> <span class="n">new_pos</span><span class="p">),</span> <span class="n">out_of_bounds</span>

    <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">)</span>
    <span class="n">new_sub_positions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">)</span>
    <span class="n">new_survived</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span>

    <span class="n">survived_dtype</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="o">.</span><span class="n">dtype</span>
    <span class="n">new_lane_directions</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span>

    <span class="k">def</span> <span class="nf">process_shark_lane</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">lane_idx</span><span class="p">):</span>
        <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Static indices relative to lane start</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">lane_idx</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">rel_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># These are fixed/static</span>

        <span class="c1"># Get direction of first shark in lane</span>
        <span class="n">lane_sharks</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">direction_of_shark</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">lane_sharks</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">lane_sharks</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">lane_sharks</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">lane_sharks</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">lane_sharks</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">survived_dtype</span><span class="p">)</span>

        <span class="c1"># Create slot indices by adding base_idx to each relative index</span>
        <span class="n">slot_indices</span> <span class="o">=</span> <span class="n">base_idx</span> <span class="o">+</span> <span class="n">rel_indices</span>

        <span class="c1"># Process all sharks in this lane simultaneously</span>
        <span class="k">def</span> <span class="nf">process_shark</span><span class="p">(</span><span class="n">shark_pos</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">):</span>
            <span class="n">new_pos</span><span class="p">,</span> <span class="n">survived</span> <span class="o">=</span> <span class="n">move_enemy</span><span class="p">(</span>
                <span class="n">shark_pos</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">step_counter</span>
            <span class="p">)</span>
            <span class="n">survived_value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">survived</span><span class="p">,</span> <span class="n">direction_of_shark</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">[</span><span class="n">slot_idx</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">survived_dtype</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_pos</span><span class="p">,</span> <span class="n">survived_value</span>

        <span class="c1"># Process all sharks in this lane simultaneously</span>
        <span class="n">new_positions</span><span class="p">,</span> <span class="n">survived_values</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">process_shark</span><span class="p">)(</span>
            <span class="n">lane_sharks</span><span class="p">,</span> <span class="n">slot_indices</span>
        <span class="p">)</span>

        <span class="c1"># Update positions using dynamic_update_slice instead of .at indexing with dynamic indices</span>
        <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_positions</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># For survived values, we need to reshape to match dimensions</span>
        <span class="c1"># (assuming survived values is a 1D array of length 3)</span>
        <span class="n">new_survived</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_survived</span><span class="p">,</span> <span class="n">survived_values</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="c1"># Get survived status for lane</span>
        <span class="n">lane_survived</span> <span class="o">=</span> <span class="n">survived_values</span>  <span class="c1"># We already have this from above</span>

        <span class="c1"># Randomize lane direction if any shark survived</span>
        <span class="n">direction_rng</span><span class="p">,</span> <span class="n">next_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">direction_rng</span><span class="p">)</span>
        <span class="n">new_lane_directions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lane_survived</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">new_lane_directions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">direction_rng</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">survived_dtype</span><span class="p">),</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">survived_dtype</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">new_lane_directions</span>
        <span class="p">)</span>

        <span class="c1"># Direction flipping logic</span>
        <span class="n">new_lane_survived</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">direction_of_shark</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">lane_survived</span><span class="p">),</span>
            <span class="n">lane_survived</span>
        <span class="p">)</span>

        <span class="c1"># Update lane survived status</span>
        <span class="n">new_survived</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_survived</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">next_rng</span><span class="p">),</span> <span class="kc">None</span>

    <span class="c1"># Similar changes for process_sub_lane</span>
    <span class="k">def</span> <span class="nf">process_sub_lane</span><span class="p">(</span><span class="n">carry</span><span class="p">,</span> <span class="n">lane_idx</span><span class="p">):</span>
        <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Static indices relative to lane start</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">lane_idx</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">rel_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>  <span class="c1"># These are fixed/static</span>

        <span class="c1"># Get direction of first sub in lane</span>
        <span class="n">lane_subs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="n">direction_of_sub</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">lane_subs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">lane_subs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">lane_subs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="n">lane_subs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="p">),</span>
            <span class="n">lane_subs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">survived_dtype</span><span class="p">)</span>

        <span class="c1"># Create slot indices by adding base_idx to each relative index</span>
        <span class="n">slot_indices</span> <span class="o">=</span> <span class="n">base_idx</span> <span class="o">+</span> <span class="n">rel_indices</span>

        <span class="k">def</span> <span class="nf">process_sub</span><span class="p">(</span><span class="n">sub_pos</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">):</span>
            <span class="n">new_pos</span><span class="p">,</span> <span class="n">survived</span> <span class="o">=</span> <span class="n">move_enemy</span><span class="p">(</span>
                <span class="n">sub_pos</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span> <span class="n">slot_idx</span><span class="p">,</span> <span class="n">step_counter</span>
            <span class="p">)</span>
            <span class="n">survived_value</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">survived</span><span class="p">,</span> <span class="n">direction_of_sub</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">[</span><span class="n">slot_idx</span><span class="p">]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">survived_dtype</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">new_pos</span><span class="p">,</span> <span class="n">survived_value</span>

        <span class="c1"># Process all subs in this lane simultaneously</span>
        <span class="n">new_positions</span><span class="p">,</span> <span class="n">survived_values</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="n">process_sub</span><span class="p">)(</span>
            <span class="n">lane_subs</span><span class="p">,</span> <span class="n">slot_indices</span>
        <span class="p">)</span>

        <span class="c1"># Update positions using dynamic_update_slice</span>
        <span class="n">new_sub_positions</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_positions</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># For survived values</span>
        <span class="n">new_survived</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_survived</span><span class="p">,</span> <span class="n">survived_values</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="c1"># Get survived status for lane</span>
        <span class="n">lane_survived</span> <span class="o">=</span> <span class="n">survived_values</span>  <span class="c1"># We already have this from above</span>

        <span class="c1"># Randomize lane direction if any sub survived</span>
        <span class="n">direction_rng</span><span class="p">,</span> <span class="n">next_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">direction_rng</span><span class="p">)</span>
        <span class="n">new_lane_directions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">lane_survived</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">new_lane_directions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">lane_idx</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">direction_rng</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">survived_dtype</span><span class="p">),</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">survived_dtype</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">new_lane_directions</span>
        <span class="p">)</span>

        <span class="c1"># Direction flipping logic</span>
        <span class="n">new_lane_survived</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">direction_of_sub</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">lane_survived</span><span class="p">),</span>
            <span class="n">lane_survived</span>
        <span class="p">)</span>

        <span class="c1"># Update lane survived status</span>
        <span class="n">new_survived</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_update_slice</span><span class="p">(</span>
            <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_survived</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">next_rng</span><span class="p">),</span> <span class="kc">None</span>

    <span class="c1"># Replace shark lane for-loop with scan</span>
    <span class="n">lane_indices</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="p">(</span><span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">process_shark_lane</span><span class="p">,</span>
        <span class="p">(</span><span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span><span class="p">),</span>
        <span class="n">lane_indices</span>
    <span class="p">)</span>

    <span class="c1"># Replace submarine lane for-loop with scan</span>
    <span class="p">(</span><span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span>
        <span class="n">process_sub_lane</span><span class="p">,</span>
        <span class="p">(</span><span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_survived</span><span class="p">,</span> <span class="n">new_lane_directions</span><span class="p">,</span> <span class="n">direction_rng</span><span class="p">),</span>
        <span class="n">lane_indices</span>
    <span class="p">)</span>

    <span class="c1"># Update spawn state with new survived status</span>
    <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
        <span class="n">survived</span><span class="o">=</span><span class="n">new_survived</span><span class="p">,</span>
        <span class="n">lane_directions</span><span class="o">=</span><span class="n">new_lane_directions</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">direction_rng</span></div>


<div class="viewcode-block" id="spawn_divers">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.spawn_divers">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">spawn_divers</span><span class="p">(</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">diver_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">SpawnState</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spawn divers according to pattern that depends on collection state.</span>

<span class="sd">    Follows these rules:</span>
<span class="sd">    1. Divers can only spawn in lanes marked as &#39;spawnable&#39; in diver_array (value 1)</span>
<span class="sd">    2. Divers only spawn in empty lanes (no enemies present)</span>
<span class="sd">    3. Divers don&#39;t spawn in lanes where submarines will spawn next</span>

<span class="sd">    Args:</span>
<span class="sd">        spawn_state: Current spawn state containing diver_array</span>
<span class="sd">        diver_positions: Current diver positions</span>
<span class="sd">        shark_positions: Current shark positions</span>
<span class="sd">        sub_positions: Current sub positions</span>
<span class="sd">        step_counter: Current step counter</span>

<span class="sd">    Returns:</span>
<span class="sd">        Updated diver positions and updated spawn state</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">spawn_diver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="c1"># Unpack carry - (positions_array, diver_array)</span>
        <span class="n">positions_array</span><span class="p">,</span> <span class="n">diver_array</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Get current diver position</span>
        <span class="n">diver_pos</span> <span class="o">=</span> <span class="n">positions_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Check if a diver exists in this slot</span>
        <span class="n">diver_exists</span> <span class="o">=</span> <span class="n">diver_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># Base index for this lane&#39;s enemies</span>
        <span class="n">base_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="c1"># Check if lane has any active enemies</span>
        <span class="n">lane_empty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                        <span class="n">is_slot_empty</span><span class="p">(</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">base_idx</span> <span class="o">+</span> <span class="n">j</span><span class="p">]),</span>
                    <span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check if this lane is marked as available for spawning (1 means spawn allowed)</span>
        <span class="n">lane_should_spawn</span> <span class="o">=</span> <span class="n">diver_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># Combine spawn conditions</span>
        <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">diver_exists</span><span class="p">),</span>  <span class="c1"># No existing diver</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">lane_should_spawn</span><span class="p">,</span> <span class="n">lane_empty</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># check if the next entity will be a submarine by checking if the previous was a shark and it survived</span>
        <span class="n">next_entity_is_sub</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">prev_sub</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">survived</span><span class="p">[</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">base_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">base_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])]),</span>
        <span class="p">)</span>

        <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">should_spawn</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">next_entity_is_sub</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Determine direction based on the to_be_spawned array</span>
        <span class="c1"># Get the relevant to_be_spawned values for this lane</span>
        <span class="n">lane_to_be_spawned</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="o">.</span><span class="n">to_be_spawned</span><span class="p">,</span> <span class="p">(</span><span class="n">base_idx</span><span class="p">,),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
        <span class="p">)</span>

        <span class="n">lane_pattern</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_dependent_pattern</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># For first wave, use the predefined pattern</span>
        <span class="c1"># For other waves, check the to_be_spawned array for direction info</span>
        <span class="n">moving_left</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">lane_directions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># Set spawn position and direction</span>
        <span class="n">x_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">moving_left</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Spawn diver if conditions are met</span>
        <span class="n">new_diver</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">should_spawn</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">DIVER_SPAWN_POSITIONS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">direction</span><span class="p">]),</span>
            <span class="n">diver_pos</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update the full positions array</span>
        <span class="n">new_positions_array</span> <span class="o">=</span> <span class="n">positions_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">new_diver</span><span class="p">)</span>

        <span class="c1"># Check for lane ready for next spawn cycle</span>
        <span class="n">spawn_next_cycle</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">diver_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lane_empty</span><span class="p">)</span>

        <span class="c1"># Then apply the next cycle updates to this temporary array</span>
        <span class="n">final_new_diver_array</span> <span class="o">=</span> <span class="n">diver_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">spawn_next_cycle</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
                <span class="n">diver_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>  <span class="c1"># Use direct indexing to get the value</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Return the updated full arrays</span>
        <span class="k">return</span> <span class="n">new_positions_array</span><span class="p">,</span> <span class="n">final_new_diver_array</span>

    <span class="c1"># Helper function to process a lane only if timer is at 60</span>
    <span class="k">def</span> <span class="nf">process_lane_if_ready</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="n">positions</span><span class="p">,</span> <span class="n">diver_array</span> <span class="o">=</span> <span class="n">carry</span>

        <span class="c1"># Check if timer for this lane is exactly 60</span>
        <span class="n">timer_is_60</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">spawn_timers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">60</span>

        <span class="c1"># Run spawn logic only if timer is 60</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">timer_is_60</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">spawn_diver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>  <span class="c1"># Process the lane if timer is 60</span>
            <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>  <span class="c1"># Skip processing if timer isn&#39;t 60</span>
            <span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">diver_array</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Process all lanes, but only execute spawn logic for lanes with timer = 60</span>
    <span class="n">new_diver_positions</span><span class="p">,</span> <span class="n">new_diver_array</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span>
        <span class="n">diver_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">process_lane_if_ready</span><span class="p">,</span>
        <span class="p">(</span><span class="n">diver_positions</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">diver_array</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_diver_positions</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">diver_array</span><span class="o">=</span><span class="n">new_diver_array</span><span class="p">)</span></div>


<div class="viewcode-block" id="step_diver_movement">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.step_diver_movement">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">step_diver_movement</span><span class="p">(</span>
    <span class="n">diver_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">state_player_x</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">state_player_y</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">state_divers_collected</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">step_counter</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">rng</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">SpawnState</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Move divers according to their pattern and handle collisions.</span>
<span class="sd">    Returns updated diver positions, number of collected divers, updated spawn state, and updated RNG key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_diver_array</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">diver_array</span>

    <span class="k">def</span> <span class="nf">calculate_diver_movement</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate diver movement based on difficulty level.</span>

<span class="sd">        Args:</span>
<span class="sd">            step_counter: Current step counter (frame number)</span>
<span class="sd">            difficulty: Current difficulty level (0-255)</span>

<span class="sd">        Returns:</span>
<span class="sd">            Movement speed for the current frame (0, 1, or 2+)</span>
<span class="sd">            0 = no movement, 1 = normal speed, 2+ = higher speeds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Ensure difficulty is non-negative and handle wrapping</span>
        <span class="n">safe_difficulty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">%</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="c1"># For difficulties 0-27, we have specific movement patterns</span>
        <span class="n">is_high_difficulty</span> <span class="o">=</span> <span class="n">safe_difficulty</span> <span class="o">&gt;=</span> <span class="mi">28</span>

        <span class="c1"># For difficulties 0-27, determine if we should move and use speed 1</span>
        <span class="n">low_diff_should_move</span> <span class="o">=</span> <span class="n">determine_low_difficulty_movement</span><span class="p">(</span>
            <span class="n">step_counter</span><span class="p">,</span> <span class="n">safe_difficulty</span>
        <span class="p">)</span>
        <span class="n">low_diff_speed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">low_diff_should_move</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># For difficulties 28+, always move but with varying speed</span>
        <span class="n">high_diff_speed</span> <span class="o">=</span> <span class="n">determine_high_difficulty_speed</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">safe_difficulty</span><span class="p">)</span>

        <span class="c1"># Return appropriate speed based on difficulty</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_high_difficulty</span><span class="p">,</span> <span class="n">high_diff_speed</span><span class="p">,</span> <span class="n">low_diff_speed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">determine_low_difficulty_movement</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if the diver should move for difficulties 0-27.&quot;&quot;&quot;</span>
        <span class="c1"># Create boolean masks for each difficulty bracket</span>
        <span class="n">diff_0_1</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">diff_2_3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">diff_4_5</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">diff_6_7</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">diff_8_9</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">diff_10_11</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">11</span><span class="p">)</span>
        <span class="n">diff_12_13</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="n">diff_14_15</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">diff_16_17</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">17</span><span class="p">)</span>
        <span class="n">diff_18_19</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">18</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">19</span><span class="p">)</span>
        <span class="n">diff_20_21</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">)</span>
        <span class="n">diff_22_23</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">22</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">)</span>
        <span class="n">diff_24_25</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">diff_26_27</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">difficulty</span> <span class="o">&gt;=</span> <span class="mi">26</span><span class="p">,</span> <span class="n">difficulty</span> <span class="o">&lt;=</span> <span class="mi">27</span><span class="p">)</span>

        <span class="c1"># Movement patterns for each bracket based on paste.txt</span>
        <span class="c1"># Difficulty 0-1: Move every 5th frame (20% movement)</span>
        <span class="n">move_0_1</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Difficulty 2-3: Move every 4th frame (25% movement)</span>
        <span class="n">move_2_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Difficulty 4-5: Move every 3rd frame (33.3% movement)</span>
        <span class="n">move_4_5</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Difficulty 6-7: Move in pattern [1,0,0,1,0,1,0,0] (37.5% movement)</span>
        <span class="n">cycle_6_7</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">move_6_7</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">cycle_6_7</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_6_7</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cycle_6_7</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Difficulty 8-9: Move in pattern [1,0,1,0,1,0,0,1,0,1] (50% movement)</span>
        <span class="n">cycle_8_9</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">10</span>
        <span class="n">move_8_9</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_8_9</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle_8_9</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_8_9</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cycle_8_9</span> <span class="o">==</span> <span class="mi">7</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">move_8_9</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">move_8_9</span><span class="p">,</span> <span class="n">cycle_8_9</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>

        <span class="c1"># Difficulty 10-11: Move every other frame (50% movement)</span>
        <span class="n">move_10_11</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Difficulty 12-13: Complex pattern with ~60% movement</span>
        <span class="n">cycle_12_13</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span>
        <span class="n">move_12_13</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_12_13</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle_12_13</span> <span class="o">==</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_12_13</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="n">cycle_12_13</span> <span class="o">==</span> <span class="mi">6</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">move_12_13</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">move_12_13</span><span class="p">,</span> <span class="n">cycle_12_13</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># Difficulty 14-15: Complex pattern with ~65% movement</span>
        <span class="n">cycle_14_15</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">7</span>
        <span class="n">move_14_15</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_14_15</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle_14_15</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_14_15</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cycle_14_15</span> <span class="o">==</span> <span class="mi">5</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">move_14_15</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">move_14_15</span><span class="p">,</span> <span class="n">cycle_14_15</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>

        <span class="c1"># Difficulty 16-17: Complex pattern with ~70% movement</span>
        <span class="n">cycle_16_17</span> <span class="o">=</span> <span class="n">step_counter</span> <span class="o">%</span> <span class="mi">10</span>
        <span class="n">move_16_17</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">move_16_17</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
            <span class="n">move_16_17</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">6</span><span class="p">,</span> <span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">move_16_17</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">move_16_17</span><span class="p">,</span> <span class="n">cycle_16_17</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>

        <span class="c1"># Difficulty 18-19: Move 3 out of 4 frames (75% movement)</span>
        <span class="n">move_18_19</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span>

        <span class="c1"># Difficulty 20-21: Move 4 out of 5 frames (80% movement)</span>
        <span class="n">move_20_21</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span>

        <span class="c1"># Difficulty 22-23: Move 7 out of 8 frames (87.5% movement)</span>
        <span class="n">move_22_23</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span>

        <span class="c1"># Difficulty 24-25: Move 15 out of 16 frames (93.75% movement)</span>
        <span class="n">move_24_25</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">15</span>

        <span class="c1"># Difficulty 26-27: Always move (100% movement)</span>
        <span class="n">move_26_27</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Combine all patterns using jnp.select which is cleaner for many conditions</span>
        <span class="c1"># Create condition array - only the first True condition will be used</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">diff_0_1</span><span class="p">,</span>
                <span class="n">diff_2_3</span><span class="p">,</span>
                <span class="n">diff_4_5</span><span class="p">,</span>
                <span class="n">diff_6_7</span><span class="p">,</span>
                <span class="n">diff_8_9</span><span class="p">,</span>
                <span class="n">diff_10_11</span><span class="p">,</span>
                <span class="n">diff_12_13</span><span class="p">,</span>
                <span class="n">diff_14_15</span><span class="p">,</span>
                <span class="n">diff_16_17</span><span class="p">,</span>
                <span class="n">diff_18_19</span><span class="p">,</span>
                <span class="n">diff_20_21</span><span class="p">,</span>
                <span class="n">diff_22_23</span><span class="p">,</span>
                <span class="n">diff_24_25</span><span class="p">,</span>
                <span class="n">diff_26_27</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create corresponding values array</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">move_0_1</span><span class="p">,</span>
                <span class="n">move_2_3</span><span class="p">,</span>
                <span class="n">move_4_5</span><span class="p">,</span>
                <span class="n">move_6_7</span><span class="p">,</span>
                <span class="n">move_8_9</span><span class="p">,</span>
                <span class="n">move_10_11</span><span class="p">,</span>
                <span class="n">move_12_13</span><span class="p">,</span>
                <span class="n">move_14_15</span><span class="p">,</span>
                <span class="n">move_16_17</span><span class="p">,</span>
                <span class="n">move_18_19</span><span class="p">,</span>
                <span class="n">move_20_21</span><span class="p">,</span>
                <span class="n">move_22_23</span><span class="p">,</span>
                <span class="n">move_24_25</span><span class="p">,</span>
                <span class="n">move_26_27</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Select the appropriate pattern based on which condition is True</span>
        <span class="n">should_move</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">conditions</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">should_move</span>

    <span class="k">def</span> <span class="nf">determine_high_difficulty_speed</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the speed (1 or 2+) for difficulties 28+.&quot;&quot;&quot;</span>
        <span class="c1"># Adjust difficulty to start from 0 for easier tier calculations</span>
        <span class="n">diff_above_27</span> <span class="o">=</span> <span class="n">difficulty</span> <span class="o">-</span> <span class="mi">28</span>

        <span class="c1"># Each 16 difficulty levels form a tier (just like in shark/submarine algorithm)</span>
        <span class="n">tier</span> <span class="o">=</span> <span class="n">diff_above_27</span> <span class="o">//</span> <span class="mi">16</span>
        <span class="n">position_in_tier</span> <span class="o">=</span> <span class="n">diff_above_27</span> <span class="o">%</span> <span class="mi">16</span>

        <span class="c1"># Base speed for each tier (increases by 1 for each tier)</span>
        <span class="n">base_speed</span> <span class="o">=</span> <span class="n">tier</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">higher_speed</span> <span class="o">=</span> <span class="n">tier</span> <span class="o">+</span> <span class="mi">2</span>

        <span class="c1"># Position brackets within tier (matches the pattern observed in paste.txt)</span>
        <span class="n">pos_0</span> <span class="o">=</span> <span class="n">position_in_tier</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">pos_1_3</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">pos_4_6</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
        <span class="n">pos_7_9</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>
        <span class="n">pos_10_12</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">)</span>
        <span class="n">pos_13_14</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
        <span class="n">pos_15</span> <span class="o">=</span> <span class="n">position_in_tier</span> <span class="o">==</span> <span class="mi">15</span>

        <span class="c1"># Determine higher speed frequency based on position in tier</span>
        <span class="c1"># These frequencies match the observed patterns in paste.txt</span>
        <span class="n">use_higher_speed_pos_0</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span>  <span class="c1"># 1 in 16 frames (6.25%)</span>
        <span class="n">use_higher_speed_pos_1_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span>  <span class="c1"># 1 in 8 frames (12.5%)</span>
        <span class="n">use_higher_speed_pos_4_6</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>  <span class="c1"># 1 in 4 frames (25%)</span>
        <span class="n">use_higher_speed_pos_7_9</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># 1 in 2 frames (50%)</span>
        <span class="n">use_higher_speed_pos_10_12</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># 3 in 4 frames (75%)</span>
        <span class="n">use_higher_speed_pos_13_14</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># 7 in 8 frames (87.5%)</span>
        <span class="n">use_higher_speed_pos_15</span> <span class="o">=</span> <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># 15 in 16 frames (93.75%)</span>

        <span class="c1"># Select the appropriate higher speed frequency based on position</span>
        <span class="c1"># Use jnp.select for cleaner code with multiple conditions</span>
        <span class="n">position_conditions</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">pos_0</span><span class="p">,</span> <span class="n">pos_1_3</span><span class="p">,</span> <span class="n">pos_4_6</span><span class="p">,</span> <span class="n">pos_7_9</span><span class="p">,</span> <span class="n">pos_10_12</span><span class="p">,</span> <span class="n">pos_13_14</span><span class="p">,</span> <span class="n">pos_15</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">speed_values</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">use_higher_speed_pos_0</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_1_3</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_4_6</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_7_9</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_10_12</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_13_14</span><span class="p">,</span>
                <span class="n">use_higher_speed_pos_15</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">use_higher_speed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">position_conditions</span><span class="p">,</span> <span class="n">speed_values</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Calculate final speed: higher_speed or base_speed</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_higher_speed</span><span class="p">,</span> <span class="n">higher_speed</span><span class="p">,</span> <span class="n">base_speed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">move_single_diver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="c1"># Unpack carry state - (positions, collected_count, diver_array)</span>
        <span class="n">positions</span><span class="p">,</span> <span class="n">collected</span><span class="p">,</span> <span class="n">diver_array</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">diver_pos</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Only process active divers (direction != 0)</span>
        <span class="n">is_active</span> <span class="o">=</span> <span class="n">diver_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># Check for collision with player first if diver is active</span>
        <span class="n">player_collision</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">is_active</span><span class="p">,</span>
            <span class="n">check_collision_single</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">state_player_x</span><span class="p">,</span> <span class="n">state_player_y</span><span class="p">]),</span>
                <span class="n">PLAYER_SIZE</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">diver_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diver_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="n">DIVER_SIZE</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Only collect if we haven&#39;t reached max divers</span>
        <span class="n">can_collect</span> <span class="o">=</span> <span class="n">state_divers_collected</span> <span class="o">&lt;</span> <span class="mi">6</span>
        <span class="n">should_collect</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">player_collision</span><span class="p">,</span> <span class="n">can_collect</span><span class="p">)</span>

        <span class="c1"># Get the three sharks in the lane</span>
        <span class="n">all_shark_lane_pos</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">dynamic_slice</span><span class="p">(</span><span class="n">shark_positions</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># Get shark in the same lane for collision check</span>
        <span class="n">shark_lane_pos</span> <span class="o">=</span> <span class="n">get_front_entity</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">all_shark_lane_pos</span><span class="p">)</span>
        <span class="n">shark_collision</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">is_active</span><span class="p">,</span>
            <span class="n">check_collision_single</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">shark_lane_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shark_lane_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="n">SHARK_SIZE</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">diver_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">diver_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
                <span class="n">DIVER_SIZE</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># check in which direction the shark is moving and copy the direction to the diver</span>
        <span class="n">direction_of_shark</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">shark_lane_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">diver_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">shark_lane_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Calculate movement based on difficulty</span>
        <span class="n">movement_speed</span> <span class="o">=</span> <span class="n">calculate_diver_movement</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">)</span>
        <span class="n">should_move</span> <span class="o">=</span> <span class="n">movement_speed</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="c1"># Calculate movement direction (with speed factor)</span>
        <span class="c1"># If colliding with shark, use shark&#39;s direction/speed</span>
        <span class="c1"># Otherwise use diver&#39;s direction with appropriate speed factor</span>
        <span class="n">movement_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">shark_collision</span><span class="p">,</span>
            <span class="n">shark_lane_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># Use shark&#39;s direction/speed</span>
            <span class="n">diver_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">movement_speed</span><span class="p">,</span>  <span class="c1"># Apply difficulty-based speed</span>
        <span class="p">)</span>

        <span class="c1"># Calculate new position</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">shark_collision</span><span class="p">,</span>
            <span class="n">diver_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_x</span><span class="p">,</span>  <span class="c1"># Move with shark</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">should_move</span><span class="p">,</span>
                <span class="n">diver_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">movement_x</span><span class="p">,</span>  <span class="c1"># Move with calculated speed</span>
                <span class="n">diver_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Stay still</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Check bounds</span>
        <span class="n">out_of_bounds</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">new_x</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">new_x</span> <span class="o">&gt;=</span> <span class="mi">170</span><span class="p">)</span>

        <span class="c1"># Create new position array - handle collection and bounds</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="o">~</span><span class="n">is_active</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">,</span> <span class="n">should_collect</span><span class="p">)),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># Reset if out of bounds or collected</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_x</span><span class="p">,</span> <span class="n">DIVER_SPAWN_POSITIONS</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">direction_of_shark</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Update collection count if collected</span>
        <span class="n">new_collected</span> <span class="o">=</span> <span class="n">collected</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_collect</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Update diver collection tracking - mark lane as collected when diver is collected</span>
        <span class="n">updated_diver_array</span> <span class="o">=</span> <span class="n">diver_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_collect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">diver_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># if the diver went out of bounds set the entry to -1</span>
        <span class="n">updated_diver_array</span> <span class="o">=</span> <span class="n">updated_diver_array</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">out_of_bounds</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">updated_diver_array</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># Update the diver position, collection count and diver_array</span>
        <span class="k">return</span> <span class="n">positions</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">new_pos</span><span class="p">),</span> <span class="n">new_collected</span><span class="p">,</span> <span class="n">updated_diver_array</span>

    <span class="c1"># Update all diver positions and track collections</span>
    <span class="n">initial_carry</span> <span class="o">=</span> <span class="p">(</span><span class="n">diver_positions</span><span class="p">,</span> <span class="n">state_divers_collected</span><span class="p">,</span> <span class="n">new_diver_array</span><span class="p">)</span>
    <span class="n">final_positions</span><span class="p">,</span> <span class="n">final_collected</span><span class="p">,</span> <span class="n">final_diver_array</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="n">diver_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">move_single_diver</span><span class="p">,</span> <span class="n">initial_carry</span>
    <span class="p">)</span>

    <span class="c1"># Handle case where all divers are collected - randomize the reset array</span>
    <span class="c1"># Split RNG key for randomization</span>
    <span class="n">rng</span><span class="p">,</span> <span class="n">reset_rng</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span>

    <span class="c1"># Generate 4 random booleans (50% chance each)</span>
    <span class="c1"># These will determine which lanes get -1 (can spawn) and which get 0 (cannot spawn)</span>
    <span class="n">random_resets</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">reset_rng</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,))</span>

    <span class="c1"># Create array with -1 for lanes that should spawn (true in random_resets)</span>
    <span class="c1"># and 0 for lanes that shouldn&#39;t (false in random_resets)</span>
    <span class="n">random_reset_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">random_resets</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Apply the reset only if all divers have been collected</span>
    <span class="n">reset_array</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">final_diver_array</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">random_reset_array</span><span class="p">,</span>  <span class="c1"># Randomized reset array</span>
        <span class="n">final_diver_array</span><span class="p">,</span>  <span class="c1"># Otherwise keep current state</span>
    <span class="p">)</span>

    <span class="c1"># Create updated spawn state</span>
    <span class="n">updated_spawn_state</span> <span class="o">=</span> <span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">diver_array</span><span class="o">=</span><span class="n">reset_array</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_positions</span><span class="p">,</span> <span class="n">final_collected</span><span class="p">,</span> <span class="n">updated_spawn_state</span><span class="p">,</span> <span class="n">rng</span></div>


<div class="viewcode-block" id="spawn_step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.spawn_step">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">spawn_step</span><span class="p">(</span>
    <span class="n">state</span><span class="p">,</span>
    <span class="n">spawn_state</span><span class="p">:</span> <span class="n">SpawnState</span><span class="p">,</span>
    <span class="n">shark_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">sub_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">diver_positions</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">rng_key</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SpawnState</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Main spawn handling function to be called in game step&quot;&quot;&quot;</span>
    <span class="c1"># Move existing enemies</span>
    <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">spawn_state_after_movement</span><span class="p">,</span> <span class="n">new_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">step_enemy_movement</span><span class="p">(</span>
            <span class="n">spawn_state</span><span class="p">,</span> <span class="n">shark_positions</span><span class="p">,</span> <span class="n">sub_positions</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">rng_key</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Update spawns using updated spawn state</span>
    <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_shark_positions</span><span class="p">,</span> <span class="n">new_sub_positions</span><span class="p">,</span> <span class="n">new_key</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">update_enemy_spawns</span><span class="p">(</span>
            <span class="n">spawn_state_after_movement</span><span class="p">,</span>
            <span class="n">new_shark_positions</span><span class="p">,</span>
            <span class="n">new_sub_positions</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
            <span class="n">new_key</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># Spawn new divers with updated tracking</span>
    <span class="n">new_diver_positions</span><span class="p">,</span> <span class="n">final_spawn_state</span> <span class="o">=</span> <span class="n">spawn_divers</span><span class="p">(</span>
        <span class="n">new_spawn_state</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">diver_positions</span><span class="p">,</span>
        <span class="n">new_shark_positions</span><span class="p">,</span>
        <span class="n">new_sub_positions</span><span class="p">,</span>
        <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">final_spawn_state</span><span class="p">,</span>
        <span class="n">new_shark_positions</span><span class="p">,</span>
        <span class="n">new_sub_positions</span><span class="p">,</span>
        <span class="n">new_diver_positions</span><span class="p">,</span>
        <span class="n">new_key</span><span class="p">,</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="surface_sub_step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.surface_sub_step">[docs]</a>
<span class="k">def</span> <span class="nf">surface_sub_step</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
    <span class="c1"># Check direction value specifically to get scalar boolean</span>
    <span class="n">sub_exists</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">spawn_sub</span><span class="p">(</span><span class="n">_</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">159</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># Always spawns right facing left</span>

    <span class="k">def</span> <span class="nf">move_sub</span><span class="p">(</span><span class="n">carry</span><span class="p">):</span>
        <span class="n">sub_pos</span> <span class="o">=</span> <span class="n">carry</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># Direction always -1</span>
            <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="c1"># Return either zeros or new position</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">new_x</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">sub_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_x</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="c1"># Each condition needs to be scalar</span>
    <span class="n">enough_rescues</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">successful_rescues</span> <span class="o">&gt;=</span> <span class="mi">2</span>
    <span class="n">enough_divers</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span> <span class="o">&gt;=</span> <span class="mi">1</span>
    <span class="n">correct_timing</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">256</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="p">)</span>

    <span class="c1"># check if the submarine should spawn</span>
    <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">enough_rescues</span><span class="p">,</span> <span class="n">enough_divers</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">correct_timing</span><span class="p">,</span> <span class="o">~</span><span class="n">sub_exists</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">temp1</span> <span class="o">=</span> <span class="n">spawn_sub</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">)</span>
    <span class="n">temp2</span> <span class="o">=</span> <span class="n">move_sub</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_spawn</span><span class="p">,</span> <span class="n">temp1</span><span class="p">,</span> <span class="n">temp2</span><span class="p">)</span></div>


<div class="viewcode-block" id="enemy_missiles_step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.enemy_missiles_step">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">enemy_missiles_step</span><span class="p">(</span>
    <span class="n">curr_sub_positions</span><span class="p">,</span> <span class="n">curr_enemy_missile_positions</span><span class="p">,</span> <span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">calculate_missile_speed</span><span class="p">(</span><span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;JAX-compatible missile speed calculation function&quot;&quot;&quot;</span>
        <span class="c1"># Base tier size is 16 difficulty levels</span>
        <span class="n">tier_size</span> <span class="o">=</span> <span class="mi">16</span>

        <span class="c1"># Determine base speed (1, 2, 3, etc.) based on difficulty tier</span>
        <span class="n">base_speed</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">difficulty</span> <span class="o">//</span> <span class="n">tier_size</span><span class="p">)</span>

        <span class="c1"># Calculate position within the current tier (0-15)</span>
        <span class="n">position_in_tier</span> <span class="o">=</span> <span class="n">difficulty</span> <span class="o">%</span> <span class="n">tier_size</span>

        <span class="c1"># Special case for difficulty 0</span>
        <span class="n">is_diff_0</span> <span class="o">=</span> <span class="n">difficulty</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># Create position bracket array for each pattern</span>
        <span class="n">pos_brackets</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">2</span>
                <span class="p">),</span>  <span class="c1"># 0-2: 6.25%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">4</span>
                <span class="p">),</span>  <span class="c1"># 3-4: 12.5%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">6</span>
                <span class="p">),</span>  <span class="c1"># 5-6: 25%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">8</span>
                <span class="p">),</span>  <span class="c1"># 7-8: 50%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">10</span>
                <span class="p">),</span>  <span class="c1"># 9-10: 75%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">12</span>
                <span class="p">),</span>  <span class="c1"># 11-12: 87.5%</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">position_in_tier</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">,</span> <span class="n">position_in_tier</span> <span class="o">&lt;=</span> <span class="mi">14</span>
                <span class="p">),</span>  <span class="c1"># 13-14: 93.75%</span>
                <span class="n">position_in_tier</span> <span class="o">==</span> <span class="mi">15</span><span class="p">,</span>  <span class="c1"># 15: 100%</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Create array of higher speed patterns</span>
        <span class="n">higher_speed_patterns</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 6.25%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 12.5%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 25%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 50%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 75%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 87.5%</span>
                <span class="p">(</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 93.75%</span>
                <span class="kc">True</span><span class="p">,</span>  <span class="c1"># 100%</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Use jnp.select to choose the pattern</span>
        <span class="n">use_higher_speed</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
            <span class="n">pos_brackets</span><span class="p">,</span> <span class="n">higher_speed_patterns</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Higher speed is base_speed + 1</span>
        <span class="n">higher_speed</span> <span class="o">=</span> <span class="n">base_speed</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># Handle difficulty 0 special case</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">is_diff_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">use_higher_speed</span><span class="p">,</span> <span class="n">higher_speed</span><span class="p">,</span> <span class="n">base_speed</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">single_missile_step</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">carry</span><span class="p">):</span>
        <span class="c1"># Input i is the loop index, carry is the full array of missile positions</span>
        <span class="c1"># Get current submarine and missile for this index</span>
        <span class="n">missile_pos</span> <span class="o">=</span> <span class="n">carry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># get the current range of the submarines in the lane</span>
        <span class="n">range_start</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">current_sub_idx</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">range_start</span><span class="p">,</span> <span class="n">range_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">range_start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="n">lane_subs</span> <span class="o">=</span> <span class="n">curr_sub_positions</span><span class="p">[</span><span class="n">current_sub_idx</span><span class="p">]</span>

        <span class="c1"># get the position of the front submarine (thats the only relevant one)</span>
        <span class="n">sub_pos</span> <span class="o">=</span> <span class="n">get_front_entity</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">lane_subs</span><span class="p">)</span>

        <span class="c1"># check if the missile is in frame</span>
        <span class="n">missile_exists</span> <span class="o">=</span> <span class="n">missile_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># check if the missile should be spawned</span>
        <span class="n">should_spawn</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">missile_exists</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MISSILE_SPAWN_POSITIONS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">MISSILE_SPAWN_POSITIONS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Calculate new missile position ( x -/+ 4 (depending on direction), y = 47, direction = sub direction)</span>
        <span class="n">new_missile_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>  <span class="c1"># could be sub_pos[0] + 4 * sub_pos[2] as well, but this is easier to read</span>
            <span class="n">sub_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sub_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">4</span>
        <span class="p">)</span>

        <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">should_spawn</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">new_missile_x</span><span class="p">,</span> <span class="n">ENEMY_MISSILE_Y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">sub_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            <span class="p">),</span>  <span class="c1"># Use submarine&#39;s direction</span>
            <span class="n">missile_pos</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">movement_speed</span> <span class="o">=</span> <span class="n">calculate_missile_speed</span><span class="p">(</span>
            <span class="n">step_counter</span><span class="p">,</span> <span class="n">difficulty</span>
        <span class="p">)</span>
        <span class="n">velocity</span> <span class="o">=</span> <span class="n">movement_speed</span> <span class="o">*</span> <span class="n">new_missile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">missile_exists</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">velocity</span><span class="p">,</span> <span class="n">new_missile</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_missile</span><span class="p">[</span><span class="mi">2</span><span class="p">]]),</span>
            <span class="n">new_missile</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Check bounds</span>
        <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">X_BORDERS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">X_BORDERS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">new_missile</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Update the missile position in the full array</span>
        <span class="k">return</span> <span class="n">carry</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">new_missile</span><span class="p">)</span>

    <span class="c1"># Update all missile positions maintaining the array shape</span>
    <span class="n">new_missile_positions</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
        <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">single_missile_step</span><span class="p">,</span> <span class="n">curr_enemy_missile_positions</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_missile_positions</span></div>


<div class="viewcode-block" id="player_missile_step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.player_missile_step">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">player_missile_step</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">curr_player_x</span><span class="p">,</span> <span class="n">curr_player_y</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
    <span class="c1"># check if the player shot this frame</span>
    <span class="n">fire</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">FIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPRIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPLEFTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNRIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNLEFTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">RIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">LEFTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPFIRE</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># IMPORTANT: do not change the order of this check, since the missile does not move in its first frame!!</span>
    <span class="c1"># also check if there is currently a missile in frame by checking if the player_missile_position is empty</span>
    <span class="n">missile_exists</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>

    <span class="c1"># if the player shot and there is no missile in frame, then we can shoot a missile</span>
    <span class="c1"># the missile y is the current player y position + 7</span>
    <span class="c1"># the missile x is either player x + 3 if facing left or player x + 13 if facing right</span>
    <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">fire</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">missile_exists</span><span class="p">)),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">player_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curr_player_x</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">curr_player_y</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curr_player_x</span> <span class="o">+</span> <span class="mi">13</span><span class="p">,</span> <span class="n">curr_player_y</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
        <span class="p">),</span>
        <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># if a missile is in frame and exists, we move the missile further in the specified direction (5 per tick), also always put the missile at the current player y position</span>
    <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">missile_exists</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">new_missile</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">5</span><span class="p">,</span> <span class="n">curr_player_y</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">new_missile</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        <span class="p">),</span>
        <span class="n">new_missile</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># check if the new positions are still in bounds</span>
    <span class="n">new_missile</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">X_BORDERS</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_missile</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">X_BORDERS</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">new_missile</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_missile</span></div>


<div class="viewcode-block" id="update_oxygen">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.update_oxygen">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">update_oxygen</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">,</span> <span class="n">player_missile_position</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update oxygen levels and handle surfacing mechanics with proper surfacing detection&quot;&quot;&quot;</span>
    <span class="n">PLAYER_BREATHING_Y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">47</span><span class="p">,</span> <span class="mi">52</span><span class="p">]</span>  <span class="c1"># Range where oxygen neither increases nor decreases</span>

    <span class="c1"># Detect actual surfacing moment</span>
    <span class="n">at_surface</span> <span class="o">=</span> <span class="n">player_y</span> <span class="o">==</span> <span class="mi">46</span>
    <span class="n">was_underwater</span> <span class="o">=</span> <span class="n">player_y</span> <span class="o">&gt;</span> <span class="mi">46</span>
    <span class="n">just_surfaced</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">at_surface</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">just_surfaced</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Check player state</span>
    <span class="n">decrease_ox</span> <span class="o">=</span> <span class="n">player_y</span> <span class="o">&gt;</span> <span class="n">PLAYER_BREATHING_Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">has_divers</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span> <span class="o">&gt;=</span> <span class="mi">0</span>  <span class="c1"># Changed to &gt; 0 instead of &gt;= 0</span>
    <span class="n">has_all_divers</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span> <span class="o">&gt;=</span> <span class="mi">6</span>
    <span class="n">needs_oxygen</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&lt;</span> <span class="mi">64</span>

    <span class="c1"># Special handling for initialization state</span>
    <span class="n">in_init_state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">just_surfaced</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">started_diving</span> <span class="o">=</span> <span class="n">player_y</span> <span class="o">&gt;</span> <span class="n">PLAYER_START_Y</span>
    <span class="n">filling_init_oxygen</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">)</span>

    <span class="c1"># Surfacing conditions</span>
    <span class="n">increase_ox</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">at_surface</span><span class="p">,</span> <span class="n">needs_oxygen</span><span class="p">)</span>
    <span class="n">stay_same</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">player_y</span> <span class="o">&gt;=</span> <span class="n">PLAYER_BREATHING_Y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">player_y</span> <span class="o">&lt;=</span> <span class="n">PLAYER_BREATHING_Y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="c1"># Calculate new divers count before other logic</span>
    <span class="n">new_divers_collected</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">just_surfaced</span><span class="p">,</span> <span class="n">has_divers</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Handle surfacing without divers - prevent during init</span>
    <span class="c1"># Only lose life if we started with no divers</span>
    <span class="n">lose_life</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">just_surfaced</span><span class="p">,</span> <span class="n">new_divers_collected</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Handle surfacing with all divers</span>
    <span class="n">should_reset</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">just_surfaced</span><span class="p">,</span> <span class="n">has_all_divers</span><span class="p">)</span>

    <span class="c1"># Update surfacing flag with consideration for remaining divers</span>
    <span class="n">new_just_surfaced</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">in_init_state</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">started_diving</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&gt;=</span> <span class="mi">63</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">was_underwater</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">at_surface</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">just_surfaced</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Handle oxygen changes</span>
    <span class="n">new_oxygen</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">filling_init_oxygen</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">decrease_ox</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">32</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">),</span>
            <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Important: Base blocking decision on has_divers instead of still_has_divers</span>
    <span class="n">can_refill</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">increase_ox</span><span class="p">,</span> <span class="n">has_divers</span><span class="p">)</span>
    <span class="n">new_oxygen</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">can_refill</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">)),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">,</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">),</span>
            <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">new_oxygen</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Increase difficulty when reaching max oxygen after surfacing</span>
    <span class="n">old_difficulty</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span>
    <span class="n">reached_max</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">new_oxygen</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">),</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">new_difficulty</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">reached_max</span><span class="p">,</span> <span class="n">old_difficulty</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">old_difficulty</span><span class="p">)</span>

    <span class="n">new_oxygen</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stay_same</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">,</span> <span class="n">new_oxygen</span><span class="p">)</span>

    <span class="c1"># Use has_divers for blocking decision and combine with oxygen check</span>
    <span class="n">should_block</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">at_surface</span><span class="p">,</span> <span class="n">needs_oxygen</span><span class="p">)</span>

    <span class="n">player_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_block</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_x</span><span class="p">)</span>

    <span class="n">player_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">should_block</span><span class="p">,</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span>  <span class="c1"># Force to exact surface position</span>
        <span class="n">player_y</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">player_missile_position</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">should_block</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">player_missile_position</span>
    <span class="p">)</span>

    <span class="c1"># Prevent oxygen depletion during init</span>
    <span class="n">oxygen_depleted</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">new_oxygen</span> <span class="o">&lt;=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">in_init_state</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">new_oxygen</span><span class="p">,</span>
        <span class="n">player_x</span><span class="p">,</span>
        <span class="n">player_y</span><span class="p">,</span>
        <span class="n">player_missile_position</span><span class="p">,</span>
        <span class="n">oxygen_depleted</span><span class="p">,</span>
        <span class="n">lose_life</span><span class="p">,</span>
        <span class="n">new_divers_collected</span><span class="p">,</span>
        <span class="n">should_reset</span><span class="p">,</span>
        <span class="n">new_just_surfaced</span><span class="p">,</span>
        <span class="n">new_difficulty</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="player_step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.player_step">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">player_step</span><span class="p">(</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
    <span class="c1"># implement all the possible movement directions for the player, the mapping is:</span>
    <span class="c1"># anything with left in it, add -1 to the x position</span>
    <span class="c1"># anything with right in it, add 1 to the x position</span>
    <span class="c1"># anything with up in it, add -1 to the y position</span>
    <span class="c1"># anything with down in it, add 1 to the y position</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UP</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPRIGHT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPLEFT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPRIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPLEFTFIRE</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">down</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWN</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNRIGHT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNLEFT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNRIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNLEFTFIRE</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">LEFT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPLEFT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNLEFT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">LEFTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPLEFTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNLEFTFIRE</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">RIGHT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPRIGHT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNRIGHT</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">RIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">UPRIGHTFIRE</span><span class="p">,</span>
                <span class="n">action</span> <span class="o">==</span> <span class="n">DOWNRIGHTFIRE</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">player_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">right</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">player_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">down</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_y</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># set the direction according to the movement</span>
    <span class="n">player_direction</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">right</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_direction</span><span class="p">))</span>

    <span class="c1"># perform out of bounds checks</span>
    <span class="n">player_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">player_x</span> <span class="o">&lt;</span> <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># Clamp to min player bound</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">player_x</span> <span class="o">&gt;</span> <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># Clamp to max player bound</span>
            <span class="n">player_x</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">player_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">player_y</span> <span class="o">&lt;</span> <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">player_y</span> <span class="o">&gt;</span> <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">PLAYER_BOUNDS</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">player_y</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="p">,</span> <span class="n">player_direction</span></div>


<div class="viewcode-block" id="calculate_kill_points">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.calculate_kill_points">[docs]</a>
<span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">calculate_kill_points</span><span class="p">(</span><span class="n">successful_rescues</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the points awarded for killing a shark or submarine. Sharks and submarines are worth 20 points.</span>
<span class="sd">    The points are increased by 10 for each successful rescue with a maximum of 90.&quot;&quot;&quot;</span>
    <span class="n">base_points</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">max_points</span> <span class="o">=</span> <span class="mi">90</span>
    <span class="n">additional_points</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">successful_rescues</span>
    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">base_points</span> <span class="o">+</span> <span class="n">additional_points</span><span class="p">,</span> <span class="n">max_points</span><span class="p">)</span></div>



<div class="viewcode-block" id="JaxSeaquest">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest">[docs]</a>
<span class="k">class</span> <span class="nc">JaxSeaquest</span><span class="p">(</span><span class="n">JaxEnvironment</span><span class="p">[</span><span class="n">SeaquestState</span><span class="p">,</span> <span class="n">SeaquestObservation</span><span class="p">,</span> <span class="n">SeaquestInfo</span><span class="p">]):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frameskip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reward_funcs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">callable</span><span class="p">]</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frameskip</span> <span class="o">=</span> <span class="n">frameskip</span>
        <span class="k">if</span> <span class="n">reward_funcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">reward_funcs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">reward_funcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reward_funcs</span> <span class="o">=</span> <span class="n">reward_funcs</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">action_set</span> <span class="o">=</span> <span class="p">{</span> 
            <span class="n">NOOP</span><span class="p">,</span>
            <span class="n">FIRE</span><span class="p">,</span>
            <span class="n">UP</span><span class="p">,</span>
            <span class="n">RIGHT</span><span class="p">,</span> 
            <span class="n">LEFT</span><span class="p">,</span>
            <span class="n">DOWN</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_stack_size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obs_size</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">4</span>

<div class="viewcode-block" id="JaxSeaquest.flatten_entity_position">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.flatten_entity_position">[docs]</a>
    <span class="k">def</span> <span class="nf">flatten_entity_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity</span><span class="p">:</span> <span class="n">EntityPosition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">entity</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">active</span><span class="p">])</span></div>


<div class="viewcode-block" id="JaxSeaquest.obs_to_flat_array">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.obs_to_flat_array">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">obs_to_flat_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">SeaquestObservation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatten_entity_position</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">player</span><span class="p">),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">sharks</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">submarines</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">divers</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">enemy_missiles</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatten_entity_position</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">surface_submarine</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatten_entity_position</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">player_missile</span><span class="p">),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">collected_divers</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">player_score</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">lives</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
            <span class="n">obs</span><span class="o">.</span><span class="n">oxygen_level</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="p">])</span></div>



<div class="viewcode-block" id="JaxSeaquest.action_space">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.action_space">[docs]</a>
    <span class="k">def</span> <span class="nf">action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_set</span><span class="p">))</span></div>


<div class="viewcode-block" id="JaxSeaquest.observation_space">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.observation_space">[docs]</a>
    <span class="k">def</span> <span class="nf">observation_space</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">high</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">def</span> <span class="nf">_get_observation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeaquestObservation</span><span class="p">:</span>
        <span class="c1"># Create player (already scalar, no need for vectorization)</span>
        <span class="n">player</span> <span class="o">=</span> <span class="n">EntityPosition</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_y</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PLAYER_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PLAYER_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">active</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>  <span class="c1"># Player is always active</span>
        <span class="p">)</span>

        <span class="c1"># Define a function to convert enemy positions to entity format</span>
        <span class="k">def</span> <span class="nf">convert_to_entity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># x position</span>
                <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># y position</span>
                <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># width</span>
                <span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># height</span>
                <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># active flag</span>
            <span class="p">])</span>

        <span class="c1"># Apply conversion to each type of entity using vmap</span>

        <span class="c1"># Sharks</span>
        <span class="n">sharks</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">convert_to_entity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">SHARK_SIZE</span><span class="p">))(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span>
        <span class="p">)</span>

        <span class="c1"># Submarines</span>
        <span class="n">submarines</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">convert_to_entity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ENEMY_SUB_SIZE</span><span class="p">))(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span>
        <span class="p">)</span>

        <span class="c1"># Divers</span>
        <span class="n">divers</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">convert_to_entity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">DIVER_SIZE</span><span class="p">))(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">diver_positions</span>
        <span class="p">)</span>

        <span class="c1"># Enemy missiles</span>
        <span class="n">enemy_missiles</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pos</span><span class="p">:</span> <span class="n">convert_to_entity</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">MISSILE_SIZE</span><span class="p">))(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span>
        <span class="p">)</span>

        <span class="c1"># Surface submarine (scalar)</span>
        <span class="n">surface_pos</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span>
        <span class="n">surface_sub</span> <span class="o">=</span> <span class="n">EntityPosition</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">surface_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># First item of first dimension</span>
            <span class="n">y</span><span class="o">=</span><span class="n">surface_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># First item of second dimension</span>
            <span class="n">width</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ENEMY_SUB_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ENEMY_SUB_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">active</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">surface_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Player missile (scalar)</span>
        <span class="n">missile_pos</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span>
        <span class="n">player_missile</span> <span class="o">=</span> <span class="n">EntityPosition</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">missile_pos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="n">missile_pos</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">width</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">MISSILE_SIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">MISSILE_SIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">active</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">missile_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Return observation</span>
        <span class="k">return</span> <span class="n">SeaquestObservation</span><span class="p">(</span>
            <span class="n">player</span><span class="o">=</span><span class="n">player</span><span class="p">,</span>
            <span class="n">sharks</span><span class="o">=</span><span class="n">sharks</span><span class="p">,</span>
            <span class="n">submarines</span><span class="o">=</span><span class="n">submarines</span><span class="p">,</span>
            <span class="n">divers</span><span class="o">=</span><span class="n">divers</span><span class="p">,</span>
            <span class="n">enemy_missiles</span><span class="o">=</span><span class="n">enemy_missiles</span><span class="p">,</span>
            <span class="n">surface_submarine</span><span class="o">=</span><span class="n">surface_sub</span><span class="p">,</span>
            <span class="n">player_missile</span><span class="o">=</span><span class="n">player_missile</span><span class="p">,</span>
            <span class="n">collected_divers</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span><span class="p">,</span>
            <span class="n">player_score</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="n">lives</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">lives</span><span class="p">,</span>
            <span class="n">oxygen_level</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">all_rewards</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SeaquestInfo</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SeaquestInfo</span><span class="p">(</span>
            <span class="n">successful_rescues</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
            <span class="n">difficulty</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="n">step_counter</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
            <span class="n">all_rewards</span><span class="o">=</span><span class="n">all_rewards</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_get_env_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">):</span> 
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">score</span> <span class="o">-</span> <span class="n">previous_state</span><span class="o">.</span><span class="n">score</span>

    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_get_all_rewards</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_funcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rewards</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">reward_func</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">for</span> <span class="n">reward_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_funcs</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rewards</span> 

    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">_get_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">state</span><span class="o">.</span><span class="n">lives</span> <span class="o">&lt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="JaxSeaquest.reset">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.reset">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SeaquestState</span><span class="p">,</span> <span class="n">SeaquestObservation</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize game state&quot;&quot;&quot;</span>
        <span class="n">reset_state</span> <span class="o">=</span> <span class="n">SeaquestState</span><span class="p">(</span>
            <span class="n">player_x</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PLAYER_START_X</span><span class="p">),</span>
            <span class="n">player_y</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PLAYER_START_Y</span><span class="p">),</span>
            <span class="n">player_direction</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">oxygen</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>  <span class="c1"># Full oxygen</span>
            <span class="n">divers_collected</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">score</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">lives</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
            <span class="n">spawn_state</span><span class="o">=</span><span class="n">initialize_spawn_state</span><span class="p">(),</span>
            <span class="n">diver_positions</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAX_DIVERS</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>  <span class="c1"># 4 divers</span>
            <span class="n">shark_positions</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAX_SHARKS</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
            <span class="n">sub_positions</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAX_SUBS</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>  <span class="c1"># x, y, direction</span>
            <span class="n">enemy_missile_positions</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MAX_ENEMY_MISSILES</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>  <span class="c1"># 4 missiles</span>
            <span class="n">surface_sub_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># 1 surface sub</span>
            <span class="n">player_missile_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>  <span class="c1"># x,y,direction</span>
            <span class="n">step_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">just_surfaced</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">successful_rescues</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">death_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">obs_stack</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1">#fill later</span>
            <span class="n">rng_key</span><span class="o">=</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">42</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">initial_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_observation</span><span class="p">(</span><span class="n">reset_state</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">expand_and_copy</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">x_expanded</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_expanded</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_stack_size</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Apply transformation to each leaf in the pytree</span>
        <span class="n">initial_obs</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="n">expand_and_copy</span><span class="p">,</span> <span class="n">initial_obs</span><span class="p">)</span>
        <span class="n">reset_state</span> <span class="o">=</span> <span class="n">reset_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">obs_stack</span><span class="o">=</span><span class="n">initial_obs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">reset_state</span><span class="p">,</span> <span class="n">initial_obs</span></div>


<div class="viewcode-block" id="JaxSeaquest.step">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.JaxSeaquest.step">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">SeaquestState</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SeaquestState</span><span class="p">,</span> <span class="n">SeaquestObservation</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">SeaquestInfo</span><span class="p">]:</span>

        <span class="n">previous_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="n">reset_state</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># First handle death animation if active</span>
        <span class="k">def</span> <span class="nf">handle_death_animation</span><span class="p">():</span>
            <span class="c1"># Calculate new positions with frozen X coordinates</span>
            <span class="n">shark_y_positions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">step_enemy_movement</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Keep X positions from original state, only update Y</span>
            <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">shark_y_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">should_hide_player</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">&lt;=</span> <span class="mi">45</span>

            <span class="c1"># Return either final reset or animation frame</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">reset_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">lives</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">lives</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">successful_rescues</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
                    <span class="n">divers_collected</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">spawn_state</span><span class="o">=</span><span class="n">soft_reset_spawn_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">),</span>
                    <span class="c1"># Lose one diver only at end of animation</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">death_counter</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">shark_positions</span><span class="o">=</span><span class="n">new_shark_positions</span><span class="p">,</span>
                    <span class="n">sub_positions</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">,</span>
                    <span class="n">enemy_missile_positions</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">,</span>
                    <span class="n">player_missile_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                    <span class="n">player_x</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_hide_player</span><span class="p">,</span> <span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">),</span>
                    <span class="n">step_counter</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">handle_score_freeze</span><span class="p">():</span>
            <span class="c1"># on scoring, the death counter will be set to -(oxygen * 2 + 16 * 6)</span>
            <span class="c1"># thats when we get in here, so duplicate the death animation pattern, but decrease the oxygen until its 0</span>
            <span class="c1"># Calculate new positions with frozen X coordinates</span>
            <span class="n">shark_y_positions</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">step_enemy_movement</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Keep X positions from original state, only update Y</span>
            <span class="n">new_shark_positions</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="o">.</span><span class="n">at</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                <span class="n">shark_y_positions</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># calculate the new oxygen</span>
            <span class="n">new_ox</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span>
            <span class="p">)</span>

            <span class="n">new_ox</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">new_ox</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">)</span>

            <span class="c1"># Return either final reset or animation frame</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">reset_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">player_x</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span>
                    <span class="n">player_y</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_y</span><span class="p">,</span>
                    <span class="n">player_direction</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_direction</span><span class="p">,</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">lives</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">lives</span><span class="p">,</span>
                    <span class="n">successful_rescues</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
                    <span class="n">divers_collected</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">spawn_state</span><span class="o">=</span><span class="n">soft_reset_spawn_state</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">),</span>
                    <span class="n">surface_sub_position</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">,</span>
                    <span class="n">oxygen</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">death_counter</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">shark_positions</span><span class="o">=</span><span class="n">new_shark_positions</span><span class="p">,</span>
                    <span class="n">sub_positions</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">,</span>
                    <span class="n">enemy_missile_positions</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">,</span>
                    <span class="n">player_missile_position</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                    <span class="n">step_counter</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">oxygen</span><span class="o">=</span><span class="n">new_ox</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Normal game logic starts here</span>
        <span class="k">def</span> <span class="nf">normal_game_step</span><span class="p">():</span>
            <span class="c1"># First check if player should be frozen for oxygen refill</span>
            <span class="n">at_surface</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">player_y</span> <span class="o">==</span> <span class="mi">46</span>
            <span class="n">needs_oxygen</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">&lt;</span> <span class="mi">64</span>
            <span class="n">should_block</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">at_surface</span><span class="p">,</span> <span class="n">needs_oxygen</span><span class="p">)</span>

            <span class="c1"># while player is frozen, keep resetting the spawn counter</span>
            <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_block</span><span class="p">,</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">spawn_timers</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">120</span><span class="p">])</span>
                <span class="p">),</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">state</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">state_updated</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">spawn_state</span><span class="o">=</span><span class="n">new_spawn_state</span><span class="p">)</span>

            <span class="c1"># If blocked, force position and disable actions</span>
            <span class="n">player_x</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_block</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">)</span>
            <span class="n">player_y</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">should_block</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">state</span><span class="o">.</span><span class="n">player_y</span>
            <span class="p">)</span>
            <span class="n">action_mod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">should_block</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">NOOP</span><span class="p">),</span> <span class="n">action</span><span class="p">)</span>

            <span class="c1"># Now calculate movement using potentially modified positions and action</span>
            <span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="n">player_direction</span> <span class="o">=</span> <span class="n">player_step</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">player_x</span><span class="o">=</span><span class="n">player_x</span><span class="p">,</span> <span class="n">player_y</span><span class="o">=</span><span class="n">player_y</span><span class="p">),</span> <span class="n">action_mod</span>
            <span class="p">)</span>
            <span class="n">player_missile_position</span> <span class="o">=</span> <span class="n">player_missile_step</span><span class="p">(</span>
                <span class="n">state</span><span class="p">,</span> <span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="n">action_mod</span>
            <span class="p">)</span>

            <span class="c1"># Rest of oxygen handling and game logic</span>
            <span class="p">(</span>
                <span class="n">new_oxygen</span><span class="p">,</span>
                <span class="n">player_x</span><span class="p">,</span>
                <span class="n">player_y</span><span class="p">,</span>
                <span class="n">player_missile_position</span><span class="p">,</span>
                <span class="n">oxygen_depleted</span><span class="p">,</span>
                <span class="n">lose_life_surfacing</span><span class="p">,</span>
                <span class="n">new_divers_collected</span><span class="p">,</span>
                <span class="n">should_reset</span><span class="p">,</span>
                <span class="n">new_just_surfaced</span><span class="p">,</span>
                <span class="n">new_difficulty</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">update_oxygen</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">next_x</span><span class="p">,</span> <span class="n">next_y</span><span class="p">,</span> <span class="n">player_missile_position</span><span class="p">)</span>

            <span class="c1"># Update divers collected count from oxygen mechanics</span>
            <span class="n">state_updated</span> <span class="o">=</span> <span class="n">state_updated</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">divers_collected</span><span class="o">=</span><span class="n">new_divers_collected</span>
            <span class="p">)</span>

            <span class="c1"># update the spawn state with the new difficulty</span>
            <span class="n">new_spawn_state</span> <span class="o">=</span> <span class="n">state_updated</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">difficulty</span><span class="o">=</span><span class="n">new_difficulty</span>
            <span class="p">)</span>

            <span class="c1"># Check missile collisions</span>
            <span class="p">(</span>
                <span class="n">player_missile_position</span><span class="p">,</span>
                <span class="n">new_shark_positions</span><span class="p">,</span>
                <span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">new_score</span><span class="p">,</span>
                <span class="n">updated_spawn_state</span><span class="p">,</span>
                <span class="n">new_rng_key</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">check_missile_collisions</span><span class="p">(</span>
                <span class="n">player_missile_position</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
                <span class="n">new_spawn_state</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">rng_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># perform all necessary spawn steps</span>
            <span class="p">(</span>
                <span class="n">new_spawn_state</span><span class="p">,</span>
                <span class="n">new_shark_positions</span><span class="p">,</span>
                <span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">new_diver_positions</span><span class="p">,</span>
                <span class="n">new_rng_key</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">spawn_step</span><span class="p">(</span>
                <span class="n">state_updated</span><span class="p">,</span>
                <span class="n">updated_spawn_state</span><span class="p">,</span>
                <span class="n">new_shark_positions</span><span class="p">,</span>
                <span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">diver_positions</span><span class="p">,</span>
                <span class="n">new_rng_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">new_diver_positions</span><span class="p">,</span> <span class="n">new_divers_collected</span><span class="p">,</span> <span class="n">new_spawn_state</span><span class="p">,</span> <span class="n">new_rng_key</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">step_diver_movement</span><span class="p">(</span>
                    <span class="n">new_diver_positions</span><span class="p">,</span>
                    <span class="n">new_shark_positions</span><span class="p">,</span>
                    <span class="n">player_x</span><span class="p">,</span>
                    <span class="n">player_y</span><span class="p">,</span>
                    <span class="n">state_updated</span><span class="o">.</span><span class="n">divers_collected</span><span class="p">,</span>
                    <span class="n">new_spawn_state</span><span class="p">,</span>
                    <span class="n">state_updated</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
                    <span class="n">new_rng_key</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">new_surface_sub_pos</span> <span class="o">=</span> <span class="n">surface_sub_step</span><span class="p">(</span><span class="n">state_updated</span><span class="p">)</span>

            <span class="n">state_updated</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">surface_sub_position</span><span class="o">=</span><span class="n">new_surface_sub_pos</span><span class="p">)</span>

            <span class="c1"># update the enemy missile positions</span>
            <span class="n">new_enemy_missile_positions</span> <span class="o">=</span> <span class="n">enemy_missiles_step</span><span class="p">(</span>
                <span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">step_counter</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># append the surface submarine to the other submarines for the collision check</span>
            <span class="c1"># check if the player has collided with any of the enemies</span>
            <span class="n">player_collision</span><span class="p">,</span> <span class="n">collision_points</span> <span class="o">=</span> <span class="n">check_player_collision</span><span class="p">(</span>
                <span class="n">player_x</span><span class="p">,</span>
                <span class="n">player_y</span><span class="p">,</span>
                <span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">new_shark_positions</span><span class="p">,</span>
                <span class="n">new_surface_sub_pos</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">,</span>
                <span class="n">new_score</span><span class="p">,</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">lose_life</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">oxygen_depleted</span><span class="p">,</span> <span class="n">player_collision</span><span class="p">,</span> <span class="n">lose_life_surfacing</span><span class="p">])</span>
            <span class="p">)</span>

            <span class="c1"># Start death animation but keep divers intact during animation</span>
            <span class="n">death_animation_state</span> <span class="o">=</span> <span class="n">state_updated</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">score</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">score</span> <span class="o">+</span> <span class="n">collision_points</span><span class="p">,</span>
                <span class="n">death_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span>
                <span class="n">spawn_state</span><span class="o">=</span><span class="n">soft_reset_spawn_state</span><span class="p">(</span><span class="n">state_updated</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># Calculate points for rescuing divers. Each diver is worth 50 points.</span>
            <span class="c1"># Each successful rescue adds 50 points with a maximum of 1000 points each.</span>
            <span class="n">base_points_per_diver</span> <span class="o">=</span> <span class="mi">50</span>
            <span class="n">max_points_per_diver</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">additional_points_per_rescue</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">successful_rescues</span>
            <span class="n">points_per_diver</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                <span class="n">base_points_per_diver</span> <span class="o">+</span> <span class="n">additional_points_per_rescue</span><span class="p">,</span>
                <span class="n">max_points_per_diver</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">total_diver_points</span> <span class="o">=</span> <span class="n">points_per_diver</span> <span class="o">*</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span>

            <span class="c1"># Calculate bonus points for remaining oxygen</span>
            <span class="n">oxygen_bonus</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">*</span> <span class="mi">20</span>

            <span class="c1"># Calculate total points for successful rescue</span>
            <span class="n">total_rescue_points</span> <span class="o">=</span> <span class="n">total_diver_points</span> <span class="o">+</span> <span class="n">oxygen_bonus</span>

            <span class="c1"># TODO: somewhere the oxygen is depleted on surfacing, this currently blocks the slow draining of oxygen (which is not gameplay relevant -&gt; low priority)</span>
            <span class="c1"># scoring freeze, 16 ticks per diver i.e. 6 * 16 and also 2 ticks per remaining oxygen (which is drained!)</span>
            <span class="c1"># Create the scoring state</span>
            <span class="n">scoring_state</span> <span class="o">=</span> <span class="n">state_updated</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                <span class="n">player_x</span><span class="o">=</span><span class="n">player_x</span><span class="p">,</span>
                <span class="n">player_y</span><span class="o">=</span><span class="n">player_y</span><span class="p">,</span>
                <span class="n">player_direction</span><span class="o">=</span><span class="n">player_direction</span><span class="p">,</span>
                <span class="n">lives</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">lives</span><span class="p">,</span>
                <span class="n">score</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">score</span> <span class="o">+</span> <span class="n">total_rescue_points</span><span class="p">,</span>
                <span class="n">successful_rescues</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">successful_rescues</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">spawn_state</span><span class="o">=</span><span class="n">soft_reset_spawn_state</span><span class="p">(</span><span class="n">state_updated</span><span class="o">.</span><span class="n">spawn_state</span><span class="p">)</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">difficulty</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">spawn_state</span><span class="o">.</span><span class="n">difficulty</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">),</span>
                <span class="n">death_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">96</span> <span class="o">+</span> <span class="n">state_updated</span><span class="o">.</span><span class="n">oxygen</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># cap the step counter to 1024</span>
            <span class="n">new_step_counter</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">==</span> <span class="mi">1024</span><span class="p">,</span>
                <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">state_updated</span><span class="o">.</span><span class="n">step_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Create the normal returned state</span>
            <span class="n">normal_returned_state</span> <span class="o">=</span> <span class="n">SeaquestState</span><span class="p">(</span>
                <span class="n">player_x</span><span class="o">=</span><span class="n">player_x</span><span class="p">,</span>
                <span class="n">player_y</span><span class="o">=</span><span class="n">player_y</span><span class="p">,</span>
                <span class="n">player_direction</span><span class="o">=</span><span class="n">player_direction</span><span class="p">,</span>
                <span class="n">oxygen</span><span class="o">=</span><span class="n">new_oxygen</span><span class="p">,</span>
                <span class="n">divers_collected</span><span class="o">=</span><span class="n">new_divers_collected</span><span class="p">,</span>
                <span class="n">score</span><span class="o">=</span><span class="n">new_score</span><span class="p">,</span>
                <span class="n">lives</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">lives</span><span class="p">,</span>
                <span class="n">spawn_state</span><span class="o">=</span><span class="n">new_spawn_state</span><span class="p">,</span>
                <span class="n">diver_positions</span><span class="o">=</span><span class="n">new_diver_positions</span><span class="p">,</span>
                <span class="n">shark_positions</span><span class="o">=</span><span class="n">new_shark_positions</span><span class="p">,</span>
                <span class="n">sub_positions</span><span class="o">=</span><span class="n">new_sub_positions</span><span class="p">,</span>
                <span class="n">enemy_missile_positions</span><span class="o">=</span><span class="n">new_enemy_missile_positions</span><span class="p">,</span>
                <span class="n">surface_sub_position</span><span class="o">=</span><span class="n">new_surface_sub_pos</span><span class="p">,</span>
                <span class="n">player_missile_position</span><span class="o">=</span><span class="n">player_missile_position</span><span class="p">,</span>
                <span class="n">step_counter</span><span class="o">=</span><span class="n">new_step_counter</span><span class="p">,</span>
                <span class="n">just_surfaced</span><span class="o">=</span><span class="n">new_just_surfaced</span><span class="p">,</span>
                <span class="n">successful_rescues</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">successful_rescues</span><span class="p">,</span>
                <span class="n">death_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="n">obs_stack</span><span class="o">=</span><span class="n">state_updated</span><span class="o">.</span><span class="n">obs_stack</span><span class="p">,</span>
                <span class="n">rng_key</span><span class="o">=</span><span class="n">new_rng_key</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># First handle surfacing with all divers (scoring)</span>
            <span class="n">intermediate_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_reset</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">scoring_state</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">normal_returned_state</span><span class="p">,</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Then handle life loss - start death animation instead of immediate reset</span>
            <span class="n">final_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">lose_life</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">death_animation_state</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">intermediate_state</span><span class="p">,</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># Check for additional life every 10,000 points</span>
            <span class="n">additional_lives</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">score</span> <span class="o">//</span> <span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">score</span> <span class="o">//</span> <span class="mi">10000</span><span class="p">)</span>
            <span class="n">new_lives</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">final_state</span><span class="o">.</span><span class="n">lives</span> <span class="o">+</span> <span class="n">additional_lives</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="c1"># max 6 lives possible</span>

            <span class="c1"># Update the final state with new lives</span>
            <span class="n">final_state</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">lives</span><span class="o">=</span><span class="n">new_lives</span><span class="p">)</span>

            <span class="c1"># Check if the game is over</span>
            <span class="n">game_over</span> <span class="o">=</span> <span class="n">final_state</span><span class="o">.</span><span class="n">lives</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">1</span>

            <span class="c1"># Handle game over state</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">game_over</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">reset_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">final_state</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
                    <span class="n">lives</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                    <span class="n">death_counter</span><span class="o">=</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">final_state</span><span class="p">,</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">return_state</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">handle_death_animation</span><span class="p">(),</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">state</span><span class="o">.</span><span class="n">death_counter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">handle_score_freeze</span><span class="p">(),</span>
                <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">normal_game_step</span><span class="p">(),</span>
                <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">operand</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Get observation and info</span>
        <span class="n">observation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_observation</span><span class="p">(</span><span class="n">return_state</span><span class="p">)</span>

        <span class="n">done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_done</span><span class="p">(</span><span class="n">return_state</span><span class="p">)</span>
        <span class="n">env_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_env_reward</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">return_state</span><span class="p">)</span>
        <span class="n">all_rewards</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_rewards</span><span class="p">(</span><span class="n">previous_state</span><span class="p">,</span> <span class="n">return_state</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_info</span><span class="p">(</span><span class="n">return_state</span><span class="p">,</span> <span class="n">all_rewards</span><span class="p">)</span>

        <span class="n">observation</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">tree_map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stack</span><span class="p">,</span> <span class="n">obs</span><span class="p">:</span> <span class="n">jnp</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">stack</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">jnp</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">return_state</span><span class="o">.</span><span class="n">obs_stack</span><span class="p">,</span> <span class="n">observation</span><span class="p">)</span>
        <span class="n">return_state</span> <span class="o">=</span> <span class="n">return_state</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">obs_stack</span><span class="o">=</span><span class="n">observation</span><span class="p">)</span>

        <span class="c1"># once done, reset the env</span>
        <span class="n">return_state</span><span class="p">,</span> <span class="n">observation</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">done</span><span class="p">,</span> 
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">(),</span>
            <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">return_state</span><span class="p">,</span> <span class="n">observation</span><span class="p">),</span>
            <span class="n">operand</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>

        <span class="c1"># Choose between death animation and normal game step</span>
        <span class="k">return</span> <span class="n">return_state</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span> <span class="n">env_reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span></div>
</div>


<span class="kn">from</span> <span class="nn">jaxtari.renderers</span> <span class="kn">import</span> <span class="n">AtraJaxisRenderer</span>

<div class="viewcode-block" id="Renderer_AtraJaxis">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.Renderer_AtraJaxis">[docs]</a>
<span class="k">class</span> <span class="nc">Renderer_AtraJaxis</span><span class="p">(</span><span class="n">AtraJaxisRenderer</span><span class="p">):</span>
<div class="viewcode-block" id="Renderer_AtraJaxis.render">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.Renderer_AtraJaxis.render">[docs]</a>
    <span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="c1"># render background</span>
        <span class="n">frame_bg</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_BG</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_bg</span><span class="p">)</span>

        <span class="c1"># render player submarine</span>
        <span class="n">frame_pl_sub</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_PL_SUB</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
            <span class="n">raster</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">player_y</span><span class="p">,</span>
            <span class="n">state</span><span class="o">.</span><span class="n">player_x</span><span class="p">,</span>
            <span class="n">frame_pl_sub</span><span class="p">,</span>
            <span class="n">flip_horizontal</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_direction</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># render player torpedo</span>
        <span class="n">frame_pl_torp</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_PL_TORP</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>
        <span class="n">should_render</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">should_render</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                <span class="n">r</span><span class="p">,</span>
                <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">frame_pl_torp</span><span class="p">,</span>
                <span class="n">flip_horizontal</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">player_missile_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
            <span class="n">raster</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># render divers</span>
        <span class="n">frame_diver</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_DIVER</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>
        <span class="n">diver_positions</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">diver_positions</span>

        <span class="k">def</span> <span class="nf">render_diver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">raster_base</span><span class="p">):</span>
            <span class="n">should_render</span> <span class="o">=</span> <span class="n">diver_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_render</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">diver_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">diver_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame_diver</span><span class="p">,</span>
                    <span class="n">flip_horizontal</span><span class="o">=</span><span class="p">(</span><span class="n">diver_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                <span class="n">raster_base</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_DIVERS</span><span class="p">,</span> <span class="n">render_diver</span><span class="p">,</span> <span class="n">raster</span><span class="p">)</span>

        <span class="c1"># render sharks</span>
        <span class="n">frame_shark</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_SHARK</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_shark</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">raster_base</span><span class="p">):</span>
            <span class="n">should_render</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_render</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame_shark</span><span class="p">,</span>
                    <span class="n">flip_horizontal</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">shark_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                <span class="n">raster_base</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Use fori_loop to render all sharks</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_SHARKS</span><span class="p">,</span> <span class="n">render_shark</span><span class="p">,</span> <span class="n">raster</span><span class="p">)</span>

        <span class="c1"># render enemy subs</span>
        <span class="n">frame_enemy_sub</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_ENEMY_SUB</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_enemy_sub</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">raster_base</span><span class="p">):</span>
            <span class="n">should_render</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_render</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame_enemy_sub</span><span class="p">,</span>
                    <span class="n">flip_horizontal</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">sub_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                <span class="n">raster_base</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_SUBS</span><span class="p">,</span> <span class="n">render_enemy_sub</span><span class="p">,</span> <span class="n">raster</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_enemy_surface_sub</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">raster_base</span><span class="p">):</span>
            <span class="n">should_render</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_render</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame_enemy_sub</span><span class="p">,</span>
                    <span class="n">flip_horizontal</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">surface_sub_position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                <span class="n">raster_base</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_SURFACE_SUBS</span><span class="p">,</span> <span class="n">render_enemy_surface_sub</span><span class="p">,</span> <span class="n">raster</span>
        <span class="p">)</span>

        <span class="n">frame_enemy_torp</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">get_sprite_frame</span><span class="p">(</span><span class="n">SPRITE_EN_TORP</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">step_counter</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">render_enemy_torp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">raster_base</span><span class="p">):</span>
            <span class="n">should_render</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
                <span class="n">should_render</span><span class="p">,</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_at</span><span class="p">(</span>
                    <span class="n">r</span><span class="p">,</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">frame_enemy_torp</span><span class="p">,</span>
                    <span class="n">flip_horizontal</span><span class="o">=</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">enemy_missile_positions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">FACE_LEFT</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">,</span>
                <span class="n">raster_base</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MAX_ENEMY_MISSILES</span><span class="p">,</span> <span class="n">render_enemy_torp</span><span class="p">,</span> <span class="n">raster</span><span class="p">)</span>

        <span class="c1"># show the scores</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">int_to_digits</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
        <span class="c1"># convert the score to a list of digits</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_label</span><span class="p">(</span><span class="n">raster</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">score_array</span><span class="p">,</span> <span class="n">DIGITS</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_indicator</span><span class="p">(</span>
            <span class="n">raster</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">lives</span><span class="p">,</span> <span class="n">LIFE_INDICATOR</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_indicator</span><span class="p">(</span>
            <span class="n">raster</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">divers_collected</span><span class="p">,</span> <span class="n">DIVER_INDICATOR</span><span class="p">,</span> <span class="n">spacing</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="n">raster</span> <span class="o">=</span> <span class="n">aj</span><span class="o">.</span><span class="n">render_bar</span><span class="p">(</span>
            <span class="n">raster</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">oxygen</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">OXYGEN_BAR_COLOR</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">raster</span></div>
</div>



<div class="viewcode-block" id="get_human_action">
<a class="viewcode-back" href="../../../modules/jaxtari.games.html#jaxtari.games.jax_seaquest.get_human_action">[docs]</a>
<span class="k">def</span> <span class="nf">get_human_action</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">chex</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get human action from keyboard with support for diagonal movement and combined fire&quot;&quot;&quot;</span>
    <span class="n">keys</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">get_pressed</span><span class="p">()</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_UP</span><span class="p">]</span> <span class="ow">or</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_w</span><span class="p">]</span>
    <span class="n">down</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_DOWN</span><span class="p">]</span> <span class="ow">or</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_s</span><span class="p">]</span>
    <span class="n">left</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_LEFT</span><span class="p">]</span> <span class="ow">or</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_a</span><span class="p">]</span>
    <span class="n">right</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_RIGHT</span><span class="p">]</span> <span class="ow">or</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_d</span><span class="p">]</span>
    <span class="n">fire</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">pygame</span><span class="o">.</span><span class="n">K_SPACE</span><span class="p">]</span>

    <span class="c1"># Diagonal movements with fire</span>
    <span class="k">if</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UPRIGHTFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UPLEFTFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWNRIGHTFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span> <span class="ow">and</span> <span class="n">left</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWNLEFTFIRE</span><span class="p">)</span>

    <span class="c1"># Cardinal directions with fire</span>
    <span class="k">if</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UPFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWNFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LEFTFIRE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">right</span> <span class="ow">and</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RIGHTFIRE</span><span class="p">)</span>

    <span class="c1"># Diagonal movements</span>
    <span class="k">if</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UPRIGHT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">up</span> <span class="ow">and</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UPLEFT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span> <span class="ow">and</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWNRIGHT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span> <span class="ow">and</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWNLEFT</span><span class="p">)</span>

    <span class="c1"># Cardinal directions</span>
    <span class="k">if</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">UP</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">down</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">DOWN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">LEFT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">right</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">RIGHT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fire</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">FIRE</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">NOOP</span><span class="p">)</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Initialize game and renderer</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">JaxSeaquest</span><span class="p">(</span><span class="n">frameskip</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">pygame</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">screen</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">set_mode</span><span class="p">((</span><span class="n">WIDTH</span> <span class="o">*</span> <span class="n">SCALING_FACTOR</span><span class="p">,</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="n">SCALING_FACTOR</span><span class="p">))</span>
    <span class="n">clock</span> <span class="o">=</span> <span class="n">pygame</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Clock</span><span class="p">()</span>

    <span class="n">renderer_AtraJaxis</span> <span class="o">=</span> <span class="n">Renderer_AtraJaxis</span><span class="p">()</span>

    <span class="c1"># Get jitted functions</span>
    <span class="n">jitted_step</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">step</span><span class="p">)</span>
    <span class="n">jitted_reset</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">game</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span>

    <span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_obs</span> <span class="o">=</span> <span class="n">jitted_reset</span><span class="p">()</span>

    <span class="c1"># Game loop with rendering</span>
    <span class="n">running</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">frame_by_frame</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">frameskip</span> <span class="o">=</span> <span class="n">game</span><span class="o">.</span><span class="n">frameskip</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">running</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">pygame</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">QUIT</span><span class="p">:</span>
                <span class="n">running</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYDOWN</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_f</span><span class="p">:</span>
                    <span class="n">frame_by_frame</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">frame_by_frame</span>
            <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYDOWN</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">KEYUP</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_n</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="n">pygame</span><span class="o">.</span><span class="n">K_n</span> <span class="ow">and</span> <span class="n">frame_by_frame</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="n">frameskip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">action</span> <span class="o">=</span> <span class="n">get_human_action</span><span class="p">()</span>
                        <span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">jitted_step</span><span class="p">(</span>
                            <span class="n">curr_state</span><span class="p">,</span> <span class="n">action</span>
                        <span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Observations: </span><span class="si">{</span><span class="n">curr_obs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward: </span><span class="si">{</span><span class="n">reward</span><span class="si">}</span><span class="s2">, Done: </span><span class="si">{</span><span class="n">done</span><span class="si">}</span><span class="s2">, Info: </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_by_frame</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">counter</span> <span class="o">%</span> <span class="n">frameskip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">get_human_action</span><span class="p">()</span>
                <span class="n">curr_state</span><span class="p">,</span> <span class="n">curr_obs</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">jitted_step</span><span class="p">(</span>
                    <span class="n">curr_state</span><span class="p">,</span> <span class="n">action</span>
                <span class="p">)</span>

        <span class="c1"># render and update pygame</span>
        <span class="n">raster</span> <span class="o">=</span> <span class="n">renderer_AtraJaxis</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">curr_state</span><span class="p">)</span>
        <span class="n">aj</span><span class="o">.</span><span class="n">update_pygame</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">raster</span><span class="p">,</span> <span class="n">SCALING_FACTOR</span><span class="p">,</span> <span class="n">WIDTH</span><span class="p">,</span> <span class="n">HEIGHT</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">clock</span><span class="o">.</span><span class="n">tick</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

    <span class="n">pygame</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Quentin Delfosse, Jannis Blüml.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>